var ChapterCtrl,GameOverCtrl,MainCtrl,NavCtrl,ResultsCtrl,SceneCtrl,WelcomeCtrl,app,_ref,_ref1,__bind=function(a,b){return function(){return a.apply(b,arguments)}},_this=this;angular.module("spin.constant",[]),angular.module("spin.animation",["ngAnimate","spin.constant"]),angular.module("spin.config",["ngRoute","spin.constant"]),angular.module("spin.controller",["ngResource","spin.constant"]),angular.module("spin.directive",["ngResource","spin.constant"]),angular.module("spin.filter",["ngResource","spin.constant"]),angular.module("spin.template",["ngRoute"]),angular.module("spin.service",["ngResource","LocalStorageModule","spin.constant"]),app=angular.module("spin",["ngRoute","ngResource","ngAnimate","ngSanitize","nouislider","btford.markdown","spin.constant","spin.animation","spin.config","spin.filter","spin.service","spin.template","spin.directive"]),angular.module("spin.animation").animation(".chapter-entrance-animation",["$timeout","constant.settings",function(a,b){return{removeClass:function(c,d,e){"ng-hide"===d?(c.stop().css("opacity",0),a(function(){return c.animate({opacity:1},b.chapterStarting/2,e)},b.chapterStarting/2)):e()},addClass:function(a,c,d){"ng-hide"===c?(a.stop().css("opacity",1),a.animate({opacity:0},b.chapterStarting/3,d)):d()}}}]),angular.module("spin.config").config(["$interpolateProvider","$httpProvider",function(a){return a.startSymbol("[["),a.endSymbol("]]")}]),angular.module("spin.config").config(["$routeProvider","$locationProvider",function(a,b){return b.html5Mode(!0),a.when("/",{templateUrl:"partials/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("spin.config").run(["$rootScope",function(a){return a.safeApply=function(a){var b;return b=this.$root.$$phase,"$apply"!==b&&"$digest"!==b?this.$apply(a):a&&"function"==typeof a?a():void 0}}]),angular.module("spin.constant").constant("constant.api",{career:"/api/career",plot:"/api/plot"}),angular.module("spin.constant").constant("constant.characters",{journaliste:"/img/head/journaliste.gif",journalisteradio:"/img/head/journalisteradio.gif",louis:"/img/head/louis.gif",martinjarendeau:"/img/head/martinjarendeau.gif",nadia:"/img/head/nadia.gif",patrickluaud:"/img/head/patrickluaud.gif"}),angular.module("spin.constant").constant("constant.settings",{mediaUrl:window.MEDIA_URL||"",chapterStarting:6e3,sequence_with_next:["dialogue","narrative","video","notification","voixoff"],sequence_blocking:["dialogue","narrative","voixoff","video","notification","choice"],sequence_dialog:["dialogue","narrative"],sequence_skip:["new_background"]}),ChapterCtrl=function(){function a(a,b,c){var d=this;this.scope=a,this.Plot=b,this.User=c,this.scope.plot=this.Plot,this.scope.user=this.User,this.chapter=this.scope.chapter=this.scope.src,this.scope.shouldShowChapter=function(){return d.chapter.id===d.User.chapter&&d.User.inGame},this.scope.chapterClasses=function(){return{"chapter--starting":c.isStartingChapter()}}}return a.$inject=["$scope","Plot","User"],a}(),angular.module("spin.controller").controller("ChapterCtrl",ChapterCtrl),GameOverCtrl=function(){function a(a,b){var c=this;this.scope=a,this.User=b,this.scope.user=this.User,this.scope.email=this.User.email,this.scope.submit=function(){return c.User.email=c.scope.email,c.User.inGame=!0}}return a.$inject=["$scope","User"],a}(),MainCtrl=function(){function a(a,b,c,d,e){this.scope=a,this.Progression=b,this.Plot=c,this.User=d,this.Sound=e,this.scope.plot=this.Plot,this.scope.user=this.User,this.scope.sound=this.Sound}return a.$inject=["$scope","Progression","Plot","User","Sound"],a}(),angular.module("spin.controller").controller("MainCtrl",MainCtrl),NavCtrl=function(){function a(a,b){var c=this;this.scope=a,this.User=b,this.scope.user=this.User,this.scope.volume=10*this.User.volume,this.scope.isVolumeOn=function(){return c.User.volume>0},this.scope.$watch("volume",function(a){return null!=a?c.User.volume=a/100:void 0})}return a.$inject=["$scope","User"],a}(),angular.module("spin.controller").controller("NavCtrl",NavCtrl),ResultsCtrl=function(){function a(a,b,c,d){var e=this;this.scope=a,this.Progression=b,this.Plot=c,this.User=d,this.scope.plot=this.Plot,this.scope.user=this.User,this.scope.shouldShowResults=function(){return e.User.isGameDone}}return a.$inject=["$scope","Progression","Plot","User"],a}(),angular.module("spin.controller").controller("ResultsCtrl",ResultsCtrl),SceneCtrl=function(){function a(a,b,c,d,e,f){var g=this;this.scope=a,this.Plot=b,this.User=c,this.Sound=d,this.scope.plot=this.Plot,this.scope.user=this.User,this.scope.sound=this.Sound,this.scene=this.scope.scene=this.scope.src,this.chapter=this.scope.chapter,this.scope.shouldShowScene=function(){return g.scene.id===g.User.scene},this.scope.shouldShowSequence=function(a){return!g.User.isStartingChapter()&&!g.User.isGameOver&&!g.User.isGameDone&&[g.getLastDialogIdx(),g.User.sequence].indexOf(a)>-1},this.scope.shouldShowNext=function(a){return f.sequence_with_next.indexOf(a.type.toLowerCase())>-1},this.isDialog=this.scope.isDialog=function(a){return f.sequence_dialog.indexOf(a.type.toLowerCase())>-1},this.isChoice=this.scope.isChoice=function(a){return"choice"===a.type.toLowerCase()},this.isPlayer=this.scope.isPlayer=function(a){return"voixoff"===a.type.toLowerCase()},this.isNewBg=this.scope.isNewBg=function(a){return"new_background"===a.type.toLowerCase()},this.isNotification=this.scope.isNotification=function(a){return"notification"===a.type.toLowerCase()},this.hasExit=this.scope.hasExit=function(a){return g.isPlayer(a)||g.isDialog(a)||g.isChoice(a)},this.scope.goToNextSequence=function(){var a;return a=g.User.nextSequence(),a&&f.sequence_skip.indexOf(a.type.toLowerCase())>-1?g.scope.goToNextSequence():void 0},this.scope.selectOption=function(a,b){return g.User.updateCareer({choice:b,scene:g.User.pos()}),g.User.goToScene(a.next_scene)},this.scope.getHeadSrc=function(a){var b;return null!=a.character?(b=a.character.toLowerCase().replace(/[^\w-]+/g,""),e[b]):void 0},this.scope.getSceneBgs=function(){var a,b,c,d,e;if(null!=g.bgs)return g.bgs;for(g.bgs=[{src:g.scene.decor[0].background,sequence:-1}],e=g.scene.sequence,a=c=0,d=e.length;d>c;a=++c)b=e[a],g.isNewBg(b)&&g.bgs.push({src:b.body,sequence:a});return g.bgs},this.scope.shouldDisplayBg=function(a){var b,c,d,e,f;for(f=_.map(g.bgs,function(a){return a.sequence}),d=0,e=f.length;e>d;d++)c=f[d],c<=g.User.sequence&&(b=c);return 0===a.sequence||a.sequence===b&&g.User.scene===g.scene.id},this.scope.toggleVoicetrack=this.Sound.toggleSequence,this.getLastDialogIdx=this.scope.getLastDialogIdx=function(){var a,b,c,d;for(a=g.User.chapter,b=g.User.scene,d=g.User.sequence;;){if(c=g.Plot.sequence(a,b,d),0>=d||null==c||g.hasExit(c))break;d--}return d}}return a.$inject=["$scope","Plot","User","Sound","constant.characters","constant.settings"],a}(),angular.module("spin.controller").controller("SceneCtrl",SceneCtrl),WelcomeCtrl=function(){function a(a,b){var c=this;this.scope=a,this.User=b,this.scope.user=this.User,this.scope.email=this.User.email,this.scope.submit=function(){return c.User.email=c.scope.email,c.User.inGame=!0}}return a.$inject=["$scope","User"],a}(),angular.module("spin.controller").controller("WelcomeCtrl",WelcomeCtrl),angular.module("spin.directive").directive("chapter",function(){return{restrict:"E",replace:!1,templateUrl:"partials/chapter.html",controller:"ChapterCtrl",scope:{src:"="}}}),angular.module("spin.directive").directive("circle",[function(){return{restrict:"A",replace:!1,scope:{percentage:"@"},link:function(a,b,c){var d,e;return e=c.id||"dk-circles-id-"+a.$id,b.attr("id",e),d=function(){var a;return a={id:e,percentage:parseFloat(c.percentage).toFixed(2),radius:parseInt(c.radius,10)||50,width:parseInt(c.width,10)||10,colors:c.colors?c.colors.split(","):["#D3B6C6","#4B253A"],duration:parseInt(c.duration,10)||null,number:" "},null!=c.text&&(a.text=c.text),window.Circles.create(a)},a.percentage?d():a.$watch(function(){return a.percentage},function(){return circleIt()})}}}]),angular.module("spin.directive").directive("scene",function(){return{restrict:"E",replace:!1,templateUrl:"partials/scene.html",controller:"SceneCtrl",scope:{src:"=",chapter:"="}}}),angular.module("spin.directive").directive("screenHeight",["$window",function(a){return function(b,c,d){var e,f;return e="screenHeight resize",f=function(){return c.css("height",a.innerHeight),isNaN(d.screenHeight)?void 0:c.css("min-height",1*d.screenHeight)},f(),angular.element(a).bind(e,f),b.$on("$destroy",function(){return angular.element(a).unbind(e)})}}]),angular.module("spin.filter").filter("checkmark",function(){return function(a){return a?"✓":"✘"}}),angular.module("spin.filter").filter("media",["constant.settings",function(a){return function(b){return a.mediaUrl+b}}]),angular.module("spin.filter").filter("minutes",function(){return function(a){var b,c;return isNaN(a)&&(a=0),b=Math.floor(a/60),c=Math.round(a-60*b),b=("0"+b).slice(-2),c=("0"+c).slice(-2),""+b+":"+c}}),angular.module("spin.filter").filter("range",function(){return function(a,b){var c;for(b=parseInt(b),c=0;b>c;)a.push(c++);return a}}),angular.module("spin.service").factory("Plot",["$http","constant.api",function(a,b){var c;return new(c=function(){function c(){this.sequence=__bind(this.sequence,this),this.scene=__bind(this.scene,this),this.chapter=__bind(this.chapter,this);var c=this;return this.chapters=[],a.get(b.plot).success(function(a){return c.chapters=a}),this}return c.prototype.chapter=function(a){return _.find(this.chapters||[],function(b){return b.id===a})},c.prototype.scene=function(a,b){var c;return c=this.chapter(a)||{},_.find(c.scenes||[],function(a){return a.id===b})},c.prototype.sequence=function(a,b,c){var d;return d=this.scene(a,b)||{sequence:[]},d.sequence[c]},c}())}]),angular.module("spin.service").factory("Progression",["$rootScope","Plot","User","Sound",function(a,b,c,d){var e;return new(e=function(){function e(){a.$watch(function(){return[c.chapter,c.inGame]},c.saveChapterChanging,!0),a.$watch(function(){return c},c.updateLocalStorage,!0),a.$watch(function(){return[b.chapters,c.scene]},function(){return d.startScene()},!0),a.$watch(function(){return c.sequence},function(){return d.toggleSequence()}),a.$watch(function(){return c.volume},d.updateVolume)}return e}())}]),angular.module("spin.service").factory("Sound",["User","Plot","$rootScope","$filter",function(a,b,c,d){var e;return new(e=function(){function e(){this.updateVolume=__bind(this.updateVolume,this),this.toggleSequence=__bind(this.toggleSequence,this),this.startScene=__bind(this.startScene,this),this.startSoundTrack=__bind(this.startSoundTrack,this)}return e.prototype.startSoundTrack=function(b){var d=this;return this.soundtrack=new Howl({urls:b,loop:!0,buffer:!0,volume:0,onplay:function(){return c.safeApply(function(){return d.soundtrack.isPlaying=!0})},onpause:function(){return c.safeApply(function(){return d.soundtrack.isPlaying=!1})},onend:function(){return c.safeApply(function(){return d.soundtrack.isPlaying=!1})}}),this.soundtrack.play(function(){return d.soundtrack.fade(0,a.volume,1e3)})},e.prototype.startScene=function(c,e){var f,g=this;if(null==c&&(c=a.chapter),null==e&&(e=a.scene),null!=e&&b.chapters.length&&null!=b.scene(c,e)&&(e=b.scene(c,e),f=[d("media")(e.decor[0].soundtrack)],null!=e.decor[0].soundtrack)){if(null==this.soundtrack)return this.startSoundTrack(f);if(!angular.equals(this.soundtrack.urls(),f))return this.soundtrack.fade(a.volume,0,1e3,function(){return g.startSoundTrack(f)})}},e.prototype.toggleSequence=function(e,f,g){var h,i,j=this;if(null==e&&(e=a.chapter),null==f&&(f=a.scene),null==g&&(g=a.sequence),null!=g)if(h=b.sequence(e,f,g),null!=h&&"voixoff"===h.type){if(i=[d("media")(h.body)],null==this.voicetrack||!angular.equals(this.voicetrack.urls(),i))return this.voicetrack=new Howl({urls:i,loop:!1,buffer:!0,volume:0,autoplay:!0,onplay:function(){return c.safeApply(function(){var b;return null!=j.soundtrack&&j.soundtrack.fade(j.soundtrack.volume(),a.volume/2),b=0===j.soundtrack.pos()?1e3:0,j.voicetrack.fade(0,a.volume,b),j.voicetrack.isPlaying=!0,j.voicetrack._interval=setInterval(function(a){return a.voicetrack._position=a.voicetrack.pos()||0,function(){return null!=a.voicetrack&&a.voicetrack.isPlaying?c.safeApply(function(){return a.voicetrack._position=a.voicetrack.pos()}):void 0}}(j),500)})},onpause:function(){return c.safeApply(function(){return j.voicetrack.isPlaying=!1})},onend:function(){return c.safeApply(function(){return null!=j.soundtrack&&j.soundtrack.fade(j.soundtrack.volume(),a.volume),c.safeApply(function(){return j.voicetrack._position=j.voicetrack._duration}),j.voicetrack.pos(0),j.voicetrack.isPlaying=!1,clearInterval(j.voicetrack._interval)})}});if(null!=this.voicetrack&&!this.voicetrack.isPlaying)return this.voicetrack.play();if(null!=this.voicetrack&&null!=this.voicetrack.isPlaying)return this.voicetrack.pause()}else if(null!=this.voicetrack&&(this.voicetrack.stop(),this.voicetrack=null),null!=h&&"notification"===h.type)return i=[d("media")(h.sound)],this.notificationtrack=new Howl({urls:i,loop:!1,buffer:!0,volume:a.volume,autoplay:!0,onplay:function(){return c.safeApply(function(){return j.notificationtrack.isPlaying=!0})},onpause:function(){return c.safeApply(function(){return j.notificationtrack.isPlaying=!1})},onend:function(){return c.safeApply(function(){return j.notificationtrack.isPlaying=!1})}})},e.prototype.updateVolume=function(a){if(null!=a)switch(!0){case null!=this.voicetrack&&null!=this.soundtrack:return this.voicetrack.volume(a),this.soundtrack.volume(a/2);case null!=this.voicetrack:return this.voicetrack.volume(a);case null!=this.soundtrack:return this.soundtrack.volume(a)}},e}())}]),angular.module("spin.service").factory("User",["$http","$timeout","constant.api","constant.settings","Plot","localStorageService","$location","$rootScope",function(a,b,c,d,e,f,g){var h;return new(h=function(){function a(){this.newUser=__bind(this.newUser,this),this.pos=__bind(this.pos,this);var a;return a=f.get("user")||{},this.inGame=!1,this.isGameOver=!1,this.isGameDone=!1,this.token=g.search().token||a.token||null,this.email=a.email||null,this.career=a.career||[],this.volume=isNaN(a.volume)?.5:a.volume,this.chapter=a.chapter||"1",this.scene=a.scene||"1",this.sequence=a.sequence||0,this.indicators={stress:a.stress||0,trust:a.trust||100,ubm:a.ubm||0,guilt:a.guilt||0,honesty:a.honesty||100,karma:a.karma||0},this.loadCareer(),this}return a.prototype.pos=function(){return this.chapter+"."+this.scene},a.prototype.newUser=function(){},a}())},git,(_ref=[null,null],this.token=_ref[0],this.email=_ref[1],_ref),(_ref1=["1","1",0],this.chapter=_ref1[0],this.scene=_ref1[1],this.sequence=_ref1[2],_ref1),this.loadCareer(),{updateLocalStorage:function(a){return null==a&&(a=_this),null!=a?localStorageService.set("user",a):void 0},updateProgression:function(a){var b;return null!=a.reached_scene&&typeof a.reached_scene===String?(b=a.reached_scene.split("."),_this.chapter=b[0],_this.scene=b[1],_this.indicators.karma=a.context.karma,_this.indicators.stress=a.context.stress,_this.indicators.trust=a.context.trust,_this.indicators.ubm=a.context.ubm,_this.sequence=0):void 0},isStartingChapter:function(){return Date.now()-_this.lastChapterChanging<settings.chapterStarting},saveChapterChanging:function(a){return null!=a?(_this.lastChapterChanging=Date.now(),null!=_this.trackChapterChanging&&$timeout.cancel(_this.trackChapterChanging),_this.chapterTrackingLoop()):void 0},chapterTrackingLoop:function(){return _this.isStartingChapter()||null==_this.trackChapterChanging?_this.trackChapterChanging=$timeout(_this.chapterTrackingLoop,200):$timeout.cancel(_this.trackChapterChanging)},loadCareer:function(){return null!=_this.token?$http.get(""+api.career+"?token="+_this.token).success(function(a){return _this.updateProgression(a)}).error(function(){return null!=_this.token||null!=_this.email?_this.newUser():void 0}):$http.post(""+api.career,{reached_scene:"1.1"}).success(function(a){return _this.token=a.token,_this.loadCareer()})},propagateChoice:function(a){var b,c,d;d=a.result[0];for(c in d)b=d[c],_this.indicators[c]+=parseInt(b);return _this.updateLocalStorage()},updateCareer:function(a){var b,c,d,e,f;return _this.token?(null!=a?(e=a,f=a.scene.split("."),b=f[0],c=f[1],d=Plot.sequence(b,c,_this.sequence),null!=d.options&&_this.propagateChoice(d.options[a.choice])):e={reached_scene:_this.pos()},$http.post(""+api.career+"?token="+_this.token,e),_this.loadCareer()):!1},nextSequence:function(){var a;return a=Plot.scene(_this.chapter,_this.scene),null!=Plot.sequence(_this.chapter,_this.scene,_this.sequence+1)?(++_this.sequence,Plot.sequence(_this.chapter,_this.scene,_this.sequence)):a&&null!=a.next_scene?(_this.goToScene(a.next_scene),Plot.sequence(_this.chapter,_this.scene,_this.sequence)):void 0},goToScene:function(a,b){var c,d,e,f,g;return null==b&&(b=!0),f=a.split("."),c=f[0],d=f[1],e=function(b){return console.warn(""+b+" doesn't exist ("+a+").")},null==Plot.chapter(c)?e("Chapter"):null==Plot.scene(c,d)?e("Scene"):_this.chapter===c&&_this.scene===d?null==Plot.sequence(c,d,_this.sequence+1)?e("Next sequence"):_this.sequence++:(g=[c,d,0],_this.chapter=g[0],_this.scene=g[1],_this.sequence=g[2],b?_this.updateCareer():void 0)}}]);
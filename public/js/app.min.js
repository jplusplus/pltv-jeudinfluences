var ChapterCtrl,MainCtrl,NavCtrl,SceneCtrl,WelcomeCtrl,app,__bind=function(a,b){return function(){return a.apply(b,arguments)}};angular.module("spin.constant",[]),angular.module("spin.animation",["ngAnimate","spin.constant"]),angular.module("spin.config",["ngRoute","spin.constant"]),angular.module("spin.controller",["ngResource","spin.constant"]),angular.module("spin.directive",["ngResource","spin.constant"]),angular.module("spin.filter",["ngResource","spin.constant"]),angular.module("spin.template",["ngRoute"]),angular.module("spin.service",["ngResource","LocalStorageModule","spin.constant"]),app=angular.module("spin",["ngRoute","ngResource","ngAnimate","spin.constant","spin.animation","spin.config","spin.filter","spin.service","spin.template","spin.directive"]),angular.module("spin.animation").animation(".chapter-entrance-animation",["$timeout","constant.delay",function(a,b){return{removeClass:function(c,d,e){"ng-hide"===d?(c.css("opacity",0),a(function(){return c.animate({opacity:1},b.chapterStarting/2,e)},b.chapterStarting/2)):e()}}}]),angular.module("spin.config").config(["$interpolateProvider","$httpProvider",function(a){return a.startSymbol("[["),a.endSymbol("]]")}]),angular.module("spin.config").config(["$routeProvider","$locationProvider",function(a,b){return b.html5Mode(!0),a.when("/",{templateUrl:"partials/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("spin.constant").constant("constant.api",{career:"/api/career",plot:"/api/plot"}),angular.module("spin.constant").constant("constant.delay",{chapterStarting:6e3}),ChapterCtrl=function(){function a(a,b,c){var d=this;this.scope=a,this.Plot=b,this.User=c,this.scope.shouldShowChapter=function(a){return a.id===d.User.chapter},this.scope.chapterClasses=function(){return{"chapter--starting":c.isStartingChapter()}}}return a.$inject=["$scope","Plot","User"],a}(),MainCtrl=function(){function a(a,b,c,d){this.scope=a,this.Plot=b,this.User=c,this.Sound=d,this.scope.plot=this.Plot,this.scope.user=this.User,this.scope.sound=this.Sound}return a.$inject=["$scope","Plot","User","Sound"],a}(),NavCtrl=function(){function a(a,b){var c=this;this.scope=a,this.User=b,this.scope.user=this.User,this.scope.volume=100*this.User.volume,this.scope.$watch("volume",function(a){return null!=a?c.User.volume=a/100:void 0})}return a.$inject=["$scope","User"],a}(),SceneCtrl=function(){function a(a,b,c){var d,e,f,g=this;this.scope=a,this.Plot=b,this.User=c,this.getLastDialogIdx=__bind(this.getLastDialogIdx,this),f=["dialogue","narrative","video","notification"],d=["dialogue","narrative","voixoff","video","notification","choice"],e=["dialogue","narrative","voixoff"],this.scope.goToNextSequence=this.User.nextSequence,this.scope.shouldShowScene=function(a){return a.id===g.User.scene},this.scope.shouldShowSequence=function(a){return[g.getLastDialogIdx(),g.User.sequence].indexOf(a)>-1},this.scope.shouldShowNext=function(a){return!0},this.isDialog=this.scope.isDialog=function(a){return e.indexOf(a.type.toLowerCase())>-1},this.isChoice=this.scope.isChoice=function(a){return"choice"===a.type.toLowerCase()},this.isNotification=this.scope.isNotification=function(a){return"notification"===a.type.toLowerCase()},this.scope.selectOption=function(a,b){return g.User.updateCareer({choice:b,scene:g.User.pos()}),g.User.goToScene(a.next_scene,!1)}}return a.$inject=["$scope","Plot","User"],a.prototype.getLastDialogIdx=function(){var a,b,c,d;for(a=this.User.chapter,b=this.User.scene,d=this.User.sequence;;){if(c=this.Plot.sequence(a,b,d),null==c||0>c||this.isDialog(c))break;d--}return d},a}(),WelcomeCtrl=function(){function a(a,b){var c=this;this.scope=a,this.User=b,this.scope.user=this.User,this.scope.email=this.User.email,this.scope.submit=function(){return c.User.email=c.scope.email,c.User.inGame=!0}}return a.$inject=["$scope","User"],a}(),angular.module("spin.directive").directive("screenHeight",["$window",function(a){return function(b,c,d){var e,f;return e="screenHeight resize",f=function(){return c.css("height",a.innerHeight),isNaN(d.screenHeight)?void 0:c.css("min-height",1*d.screenHeight)},f(),angular.element(a).bind(e,f),b.$on("$destroy",function(){return angular.element(a).unbind(e)})}}]),angular.module("spin.filter").filter("checkmark",function(){return function(a){return a?"✓":"✘"}}),angular.module("spin.filter").filter("range",function(){return function(a,b){var c;for(b=parseInt(b),c=0;b>c;)a.push(c++);return a}}),angular.module("spin.service").factory("Plot",["$http","constant.api",function(a,b){var c;return new(c=function(){function c(){this.sequence=__bind(this.sequence,this),this.scene=__bind(this.scene,this),this.chapter=__bind(this.chapter,this);var c=this;return this.chapters=[],a.get(b.plot).success(function(a){return c.chapters=a}),this}return c.prototype.chapter=function(a){return _.find(this.chapters||[],function(b){return b.id===a})},c.prototype.scene=function(a,b){var c;return c=this.chapter(a)||{},_.find(c.scenes||[],function(a){return a.id===b})},c.prototype.sequence=function(a,b,c){var d;return d=this.scene(a,b)||{sequence:[]},d.sequence[c]},c}())}]),angular.module("spin.service").factory("Sound",["User","Plot","$rootScope",function(a,b,c){var d;return new(d=function(){function d(){this.updateVolume=__bind(this.updateVolume,this),this.startSequence=__bind(this.startSequence,this),this.startScene=__bind(this.startScene,this);var d=this;c.$watch(function(){return b.chapters||a.scene},function(){return d.startScene()}),c.$watch(function(){return a.sequence},function(){return d.startSequence()}),c.$watch(function(){return a.volume},this.updateVolume)}return d.prototype.startScene=function(c,d){var e,f=this;return null==c&&(c=a.chapter),null==d&&(d=a.scene),null!=d&&b.chapters.length&&null!=b.scene(c,d)&&(d=b.scene(c,d),e=[d.decor[0].soundtrack],null==this.soundtrack||!angular.equals(this.soundtrack.urls(),e))?(this.soundtrack=new Howl({urls:e,loop:!0,buffer:!0,volume:0}),this.soundtrack.play(function(){return f.soundtrack.fade(0,a.volume,2e3)})):void 0},d.prototype.startSequence=function(c,d,e){var f,g=this;if(null==c&&(c=a.chapter),null==d&&(d=a.scene),null==e&&(e=a.sequence),null!=e)if(e=b.sequence(c,d,e),null!=e&&"voixoff"===e.type){if(f=[e.body],null==this.voicetrack||!angular.equals(this.voicetrack.urls(),f))return this.voicetrack=new Howl({urls:f,loop:!1,buffer:!0,volume:0}),null!=this.soundtrack&&this.soundtrack.fade(this.soundtrack.volume(),a.volume/2),this.voicetrack.play(function(){return g.voicetrack.fade(0,a.volume,2e3)})}else if(null!=this.voicetrack)return null!=this.soundtrack&&this.soundtrack.fade(this.soundtrack.volume(),a.volume),this.voicetrack.fade(this.voicetrack.volume(),0,2e3,function(){return g.voicetrack.stop()})},d.prototype.updateVolume=function(a){if(null!=a)switch(!0){case null!=this.voicetrack&&null!=this.soundtrack:return this.voicetrack.volume(a),this.soundtrack.volume(a/2);case null!=this.voicetrack:return this.voicetrack.volume(a);case null!=this.soundtrack:return this.soundtrack.volume(a)}},d}())}]),angular.module("spin.service").factory("User",["$http","$timeout","constant.api","constant.delay","Plot","localStorageService","$location","$rootScope",function(a,b,c,d,e,f,g,h){var i;return new(i=function(){function i(){this.goToScene=__bind(this.goToScene,this),this.nextSequence=__bind(this.nextSequence,this),this.updateCareer=__bind(this.updateCareer,this),this.loadCareer=__bind(this.loadCareer,this),this.chapterTrackingLoop=__bind(this.chapterTrackingLoop,this),this.saveChapterChanging=__bind(this.saveChapterChanging,this),this.isStartingChapter=__bind(this.isStartingChapter,this),this.updateProgression=__bind(this.updateProgression,this),this.updateLocalStorage=__bind(this.updateLocalStorage,this),this.newUser=__bind(this.newUser,this),this.pos=__bind(this.pos,this);var a,b=this;return a=f.get("user")||{},this.inGame=!1,this.token=g.search().token||a.token||null,this.email=a.email||null,this.career=a.career||[],this.volume=isNaN(a.volume)?.5:a.volume,this.chapter=a.chapter||"1",this.scene=a.scene||"1",this.sequence=a.sequence||0,this.ubm=a.ubm||0,this.trust=a.trust||0,this.stress=a.stress||0,this.karma=a.karma||100,this.loadCareer(),h.$watch(function(){return[b.chapter,b.inGame]},this.saveChapterChanging,!0),h.$watch(function(){return b},this.updateLocalStorage,!0),this}return i.prototype.pos=function(){return this.chapter+"."+this.scene},i.prototype.newUser=function(){var a,b;return a=[null,null],this.token=a[0],this.email=a[1],b=["1","1",0],this.chapter=b[0],this.scene=b[1],this.sequence=b[2],this.loadCareer()},i.prototype.updateLocalStorage=function(a){return null==a&&(a=this),null!=a?f.set("user",a):void 0},i.prototype.updateProgression=function(a){var b;return null!=a.reached_scene&&typeof a.reached_scene===String?(b=a.reached_scene.split("."),this.chapter=b[0],this.scene=b[1],this.karma=a.context.karma,this.stress=a.context.stress,this.trust=a.context.trust,this.ubm=a.context.ubm,this.sequence=0):void 0},i.prototype.isStartingChapter=function(){return Date.now()-this.lastChapterChanging<d.chapterStarting},i.prototype.saveChapterChanging=function(a){return null!=a?(this.lastChapterChanging=Date.now(),null!=this.trackChapterChanging&&b.cancel(this.trackChapterChanging),this.chapterTrackingLoop()):void 0},i.prototype.chapterTrackingLoop=function(){return this.isStartingChapter()||null==this.trackChapterChanging?this.trackChapterChanging=b(this.chapterTrackingLoop,200):b.cancel(this.trackChapterChanging)},i.prototype.loadCareer=function(){var b=this;return null!=this.token?a.get(""+c.career+"?token="+this.token).success(function(a){return b.updateProgression(a)}).error(function(){return null!=b.token||null!=b.email?b.newUser():void 0}):a.post(""+c.career,{}).success(function(a){return b.token=a.token,b.loadCareer()})},i.prototype.updateCareer=function(b){var d;return this.token?(d=null!=b?b:{reached_scene:this.pos()},a.post(""+c.career+"?token="+this.token,d)):!1},i.prototype.nextSequence=function(){return null!=e.sequence(this.chapter,this.scene,this.sequence+1)?++this.sequence:null!=this.scene.next_scene?this.goToScene(this.scene.next_scene):void 0},i.prototype.goToScene=function(a,b){var c,d,f,g,h;return null==b&&(b=!0),g=a.split("."),c=g[0],d=g[1],f=function(b){return console.warn(""+b+" doesn't exist ("+a+").")},null==e.chapter(c)?f("Chapter"):null==e.scene(c,d)?f("Scene"):this.chapter===c&&this.scene===d?null==e.sequence(c,d,this.sequence+1)?f("Next sequence"):this.sequence++:(h=[c,d,0],this.chapter=h[0],this.scene=h[1],this.sequence=h[2],b?this.updateCareer():void 0)},i}())}]);
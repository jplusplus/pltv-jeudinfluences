var ChapterCtrl,GameDoneCtrl,GameOverCtrl,MainCtrl,NavCtrl,PageCtrl,ResultsCtrl,SceneCtrl,WelcomeCtrl,app,assert,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty;angular.module("spin.constant",[]),angular.module("spin.animation",["ngAnimate","spin.constant"]),angular.module("spin.config",["ngRoute","ngSanitize","spin.constant","spin.service"]),angular.module("spin.controller",["ngResource","spin.constant","spin.filter"]),angular.module("spin.directive",["ngResource","spin.constant"]),angular.module("spin.filter",["ngResource","spin.constant"]),angular.module("spin.template",["ngRoute"]),angular.module("spin.service",["ngResource","LocalStorageModule","spin.constant"]),app=angular.module("spin",["ngRoute","ngResource","ngAnimate","ngTouch","ngSanitize","nouislider","btford.markdown","spin.constant","spin.animation","spin.config","spin.filter","spin.service","spin.template","spin.directive"]),angular.module("spin.animation").animation(".chapter-entrance-animation",["$timeout","constant.settings",function(a,b){return{enter:function(c,d){return c.css("opacity",0),a(function(){return jQuery(c[0]).animate({opacity:1},b.chapterEntrance/3,d)},b.chapterEntrance/3),function(a){return a?jQuery(c[0]).stop():void 0}},leave:function(a,c){return a.css("opacity",1),jQuery(a[0]).animate({opacity:0},b.chapterEntrance/3,c),function(b){return b?jQuery(a[0]).stop():void 0}}}}]),angular.module("spin.animation").animation(".scene-entrance-animation",["constant.settings",function(a){return{enter:function(b,c){return b.css("opacity",0),jQuery(b[0]).animate({opacity:1},a.sceneEntrance,c),function(a){return a?jQuery(b[0]).stop():void 0}},leave:function(b,c){return b.css("opacity",1),jQuery(b[0]).animate({opacity:0},a.sceneEntrance,c),function(a){return a?jQuery(b[0]).stop():void 0}}}}]),angular.module("spin.config").config(["$interpolateProvider","$httpProvider",function(a){return a.startSymbol("[["),a.endSymbol("]]")}]),angular.module("spin.config").config(["$routeProvider","$locationProvider",function(a,b){return b.html5Mode(!0),a.when("/",{templateUrl:"partials/main.html",controller:"MainCtrl",reloadOnSearch:!1}).otherwise({redirectTo:"/"})}]),angular.module("spin.config").run(["$rootScope",function(a){return a.safeApply=function(a){var b;return b=this.$root.$$phase,"$apply"!==b&&"$digest"!==b?this.$apply(a):a&&"function"==typeof a?a():void 0}}]),angular.module("spin.config").config(["$sceDelegateProvider",function(a){return a.resourceUrlWhitelist(["self","http://*.dailymotion.com/**","https://*.dailymotion.com/**"])}]),angular.module("spin.config").run(["$rootScope","User",function(a,b){return a.user=b}]),angular.module("spin.constant").constant("constant.api",{career:"/api/career",plot:"/api/plot",associate:"/api/career/associate_email",results:"/api/summary",erase:"/api/career/erase",finalSummary:"/api/summary/final",page:"/api/page"}),angular.module("spin.constant").constant("constant.characters",{journaliste:"/img/head/journaliste.gif",journalisteradio:"/img/head/journalisteradio.gif",louis:"/img/head/louis.gif",martinjarendeau:"/img/head/martinjarendeau.gif",nadia:"/img/head/nadia.gif",patrickluaud:"/img/head/patrickluaud.gif"}),angular.module("spin.constant").constant("constant.doors",{theEnd:["This is the end, beautiful friend","This is the end, my only friend, the end","Of our elaborate plans, the end","Of everything that stands, the end","No safety or surprise, the end","I'll never look into your eyes, again","Can you picture what will be, so limitless and free","Desperately in need, of some, stranger's hand","In a, desperate land","Lost in a Roman wilderness of pain","And all the children are insane, all the children are insane","Waiting for the summer rain, yeah","There's danger on the edge of town","Ride the King's highway, baby","Weird scenes inside the gold mine","Ride the highway west, baby","Ride the snake, ride the snake","To the lake, the ancient lake, baby","The snake is long, seven miles","Ride the snake, he's old, and his skin is cold","The west is the best, the west is the best","Get here, and we'll do the rest","The blue bus is callin' us, the blue bus is callin' us","Driver, where you taken us","The killer awoke before dawn, he put his boots on","He took a face from the ancient gallery","And he walked on down the hall","He went into the room where his sister lived, and, then he","Paid a visit to his brother, and then he","He walked on down the hall, and","And he came to a door, and he looked inside","Father, yes son, I want to kill you","Mother, I want to, fuck you","C'mon baby, take a chance with us","C'mon baby, take a chance with us","C'mon baby, take a chance with us","And meet me at the back of the blue bus","Doin' a blue rock, on a blue bus","Doin' a blue rock, c'mon, yeah","Kill, kill, kill, kill, kill, kill","This is the end, beautiful friend","This is the end, my only friend, the end","It hurts to set you free","But you'll never follow me","The end of laughter and soft lies","The end of nights we tried to die","This is the end"]}),angular.module("spin.constant").constant("constant.gameover-sentences",{"default":"Ne soyez pas si têtu(e). Vous feriez mieux de suivre les conseils de Patrick Luaud. Ou alors, au moins, faites lui croire que c'est le cas. Recommencez ce chapitre et tâchez d'appliquer une stratégie plus fine. Quels que soient vos choix.",ubm:'Vous avez sous-estimé les médias. Grossière erreur. Louis va bientôt être brisé par le troisième coup des trois "L", règle typique de toute crise médiatique : Lèche, Lâche, Lynche. Recommencez ce chapitre et soyez vigilant à votre attitude vis-à-vis des médias.',trust:"Aussi paradoxal que cela puisse vous paraitre, la règle d'or d'un spin doctor est la confiance en son client. Vous avez perdu celle que vous accordait Patrick Luaud. Louis, laissé seul en pleine crise médiatique, s'est noyé. Recommencez ce chapitre et tâchez d'appliquer une stratégie plus fine. Quels que soient vos choix.",stress:"Lâchez la souris, posez votre téléphone, éteignez LCI et France Info, fermez Twitter mais surtout fermez les yeux et respirez profondément. Vous avez perdu. Faute de sang-froid. Louis a implosé en vol. Malgré les traitements, il va mettre du temps à sortir de cette dépression. Recommencez ce chapitre et cette fois-ci ne vous laissez pas submerger par la pression, qu'elle soit médiatique ou intime."}),angular.module("spin.constant").constant("constant.indicators",{meta:{rules:{lessThanOrEqual:"lte",lessThan:"lt",greaterThanOrEqual:"gte",greaterThan:"gt"}},all:{karma:{start:0,max:50,min:-50,gameOver:{on:"min",rule:"lte"}},ubm:{start:0,min:0,max:100,gameOver:{on:"max",rule:"gte"}},trust:{min:0,max:100,start:.1,gameOver:{on:"min",rule:"lte"}},stress:{min:0,max:100,start:0,gameOver:{on:"max",rule:"gte"}}}}),angular.module("spin.constant").constant("constant.keys",{next:[39,32]}),angular.module("spin.constant").constant("constant.settings",{mediaUrl:window.MEDIA_URL||"",chapterEntrance:5e3,sceneEntrance:1e3,feedbackDuration:2e3,sequenceWithNext:["dialogue","narrative","notification","voixoff"],sequenceDialog:["dialogue","narrative"],sequenceSkip:["new_background"],timeoutRefRate:100,mainScenes:{1:["1.1","1.4","1.6"],2:["2.6","2.16","2.27"],3:["3.10","3.18","3.26","3.28"],4:["4.17","4.23","4.31"],5:["5.13","5.26","5.42"],6:["6.3","6.9","6.13","6.17","6.28","6.33"]}}),angular.module("spin.constant").constant("constant.states",{user:{iddle:"iddle",inGame:"gaming",startingChatper:"startingChatper",summary:"summary",gameOver:"gameover"}}),angular.module("spin.constant").constant("constant.types",{sequence:{choice:"choice",video:"video",player:"voixoff",newBackground:"new_background",videoBackground:"video_background",feedback:"feedback",notification:"notification",gameOver:"gameover"},scene:{theEnd:"the_end"}}),angular.module("spin.constant").constant("constant.xiti",{xtsd:"http://logc238",xtsite:"475907",xtn2:"65",prefix:""}),ChapterCtrl=function(){function a(a,b,c,d){var e=this;this.scope=a,this.Plot=b,this.User=c,this.filter=d,this.shouldShowChapter=__bind(this.shouldShowChapter,this),this.scope.plot=this.Plot,this.scope.user=this.User,this.chapter=this.scope.chapter=this.scope.src,this.scope.shouldShowChapter=this.shouldShowChapter,this.scope.chapterClasses=function(){return{"chapter--starting":c.isStartingChapter(),"chapter--loading":!c.isReady}},this.scope.getBackgrounds=function(){var a;return null!=e.bgs?e.bgs:(e.bgs=[],a=e.filter("media"),angular.forEach(e.chapter.scenes,function(b){return null!=b.decor&&null!=b.decor[0].background&&e.bgs.push(a(b.decor[0].background)),angular.forEach(b.sequence,function(b){return b.isNewBg()&&null!==b.body?e.bgs.push(a(b.body)):void 0})}),e.bgs)}}return a.$inject=["$scope","Plot","User","$filter"],a.prototype.shouldShowChapter=function(){return this.User.isSummary?this.User.lastChapter===this.chapter.id:this.User.inGame&&this.chapter.id===this.User.chapter},a}(),angular.module("spin.controller").controller("ChapterCtrl",ChapterCtrl),GameDoneCtrl=function(){function a(a,b,c,d,e){var f=this;this.scope=a,this.http=b,this.api=c,this.User=d,this.ThirdParty=e,this.getResults=__bind(this.getResults,this),this.shouldShowTheEnd=__bind(this.shouldShowTheEnd,this),this.scope.user=this.User,this.scope.thirdParty=this.ThirdParty,this.scope.shouldShowTheEnd=this.shouldShowTheEnd,this.scope.gameDoneSentence=this.gameDoneSentence,this.scope.$watch("user.isGameDone",this.getResults),this.scope.isInnocent=function(){return f.User.indicators.guilt<50},this.scope.isGuilty=function(){return!f.scope.isInnocent()},this.scope.isHonest=function(){return f.User.indicators.honesty>=50},this.scope.isLier=function(){return!f.scope.isHonest()},this.scope.isMurderer=function(){return null!=f.User.indicators.meurtre}}return a.$inject=["$scope","$http","constant.api","User","ThirdParty"],a.prototype.shouldShowTheEnd=function(){return this.User.isGameDone},a.prototype.getResults=function(){var a,b=this;return a=""+this.api.finalSummary+"?token="+this.User.token,this.http.get(a).then(function(a){return b.scope.results=a.data})},a}(),GameOverCtrl=function(){function a(a,b,c){var d=this;this.scope=a,this.User=c,this.scope.gameOverSentence=function(){return b[d.User.gameOverReason||"default"]},this.scope.user=this.User,this.scope.restart=function(){return d.User.restartChapter()}}return a.$inject=["$scope","constant.gameover-sentences","User"],a}(),MainCtrl=function(){function a(a,b,c,d,e,f){this.scope=a,this.Progression=b,this.Plot=c,this.User=d,this.Sound=e,this.Xiti=f,this.scope.plot=this.Plot,this.scope.user=this.User,this.scope.sound=this.Sound}return a.$inject=["$scope","Progression","Plot","User","Sound","Xiti"],a}(),angular.module("spin.controller").controller("MainCtrl",MainCtrl),NavCtrl=function(){function a(a,b,c){var d=this;this.scope=a,this.User=b,this.ThirdParty=c,this.save=__bind(this.save,this),this.shouldShowSaveButton=__bind(this.shouldShowSaveButton,this),this.scope.user=this.User,this.scope.thirdParty=this.ThirdParty,this.scope.volume=100*this.User.volume,this.scope.volumeBp=0===this.scope.volume?100:this.scope.volume,this.scope.isVolumeOn=function(){return d.User.volume>0},this.scope.toggleVolume=function(){return 0===d.User.volume?(d.scope.volume=d.scope.volumeBp,d.User.volume=d.scope.volume/100):(d.scope.volumeBp=d.scope.volume,d.User.volume=d.scope.volume=0)},this.scope.$watch("volume",function(a){return null!=a?d.User.volume=a/100:void 0}),this.scope.shouldShowSaveButton=this.shouldShowSaveButton,this.scope.save=this.save,this._shouldShowSaveButton=!0,this.scope.$watch(function(){return b.inGame},function(a,b){return null!=d.User.email&&a&&!b?d._shouldShowSaveButton=!1:void 0}),this.scope.$watch("shouldShowSaveForm",function(a,b){return null!=d.User.email&&b&&!a?d._shouldShowSaveButton=!1:void 0})}return a.$inject=["$scope","User","ThirdParty"],a.prototype.shouldShowSaveButton=function(){return this.User.inGame&&this._shouldShowSaveButton},a.prototype.save=function(){var a,b=this;return a=this.scope.email,this.User.associate(a).success(function(){return b.User.email=a}).error(function(){})},a}(),angular.module("spin.controller").controller("NavCtrl",NavCtrl),PageCtrl=function(){function a(a,b,c,d){var e=this;this.scope=a,this.location=b,this.http=c,this.api=d,this.close=__bind(this.close,this),this.loadPage=__bind(this.loadPage,this),this.scope.page=!1,this.scope.close=this.close,this.scope.$watch(function(){return e.location.search().p},this.loadPage,!0)}return a.$inject=["$scope","$location","$http","constant.api"],a.prototype.loadPage=function(a){var b=this;return null!=a?this.http.get(this.api.page+"/"+a).success(function(a){return b.scope.page=a.page}):this.scope.page=!1},a.prototype.close=function(){return this.location.search("p",null)},a}(),angular.module("spin.controller").controller("PageCtrl",PageCtrl),ResultsCtrl=function(){function a(a,b,c,d,e,f){this.scope=a,this.ThirdParty=b,this.Progression=c,this.User=d,this.Plot=e,this.Results=f,this.onChapterChanged=__bind(this.onChapterChanged,this),this.previousResults=__bind(this.previousResults,this),this.hasPreviousResults=__bind(this.hasPreviousResults,this),this.shouldShowResults=__bind(this.shouldShowResults,this),this.goNextChapter=__bind(this.goNextChapter,this),this.scope.plot=this.Plot,this.scope.user=this.User,this.scope.thirdParty=this.ThirdParty,this.scope.shouldShowResults=this.shouldShowResults,this.scope.goNextChapter=this.goNextChapter,this.scope.hasPreviousResults=this.hasPreviousResults,this.scope.previousResults=this.previousResults,this.scope.$watch("user.chapter",this.onChapterChanged,!0)}return a.$inject=["$scope","ThirdParty","Progression","User","Plot","Results"],a.prototype.goNextChapter=function(){return this.scope.safeApply(this.User.leaveSummary)},a.prototype.shouldShowResults=function(){return this.User.isSummary&&this.User.inGame&&!this.User.isGameOver},a.prototype.hasPreviousResults=function(){return _.keys(this.previousResults()).length>0},a.prototype.previousResults=function(){return null!=this.scope.currentChapter?_.omit(this.Results.list,this.scope.currentChapter.id):void 0},a.prototype.onChapterChanged=function(a,b){var c,d=this;return c=this.Plot.chapter(b),c&&c.bilan?this.scope.safeApply(function(){return d.scope.currentChapter=c,d.Results.get(c).then(function(a){return d.scope.currentResults=a},function(){return d.User.isSummary=!1,d.scope.currentResults=void 0})}):void 0},a}(),angular.module("spin.controller").controller("ResultsCtrl",ResultsCtrl),SceneCtrl=function(){function a(a,b,c,d,e){var f=this;this.scope=a,this.Plot=b,this.User=c,this.Sound=d,this.Timeout=e,this.scope.plot=this.Plot,this.scope.user=this.User,this.scope.sound=this.Sound,this.scope.timeout=this.Timeout,this.scene=this.scope.scene=this.scope.src,this.chapter=this.scope.chapter,this.shouldShowScene=this.scope.shouldShowScene=function(){return f.User.isSummary?f.User.lastScene===f.scene.id&&f.chapter.id===f.User.lastChapter:f.scene.id===f.User.scene},this.scope.shouldShowSequence=function(a){return f.shouldShowScene()&&!f.User.isStartingChapter()&&!f.User.isGameOver&&!f.User.isGameDone&&!f.User.isSummary&&[f.getLastDialogIdx(),f.User.sequence].indexOf(a)>-1},this.scope.goToNextSequence=function(){return f.User.nextSequence()},this.scope.selectOption=function(a,b){var c,d;return f.Timeout.cancel(),f.User.updateCareer({choice:b,scene:f.User.pos()}),null!=a.outro?(c=f.Plot.scene(f.User.chapter,f.User.scene),d={type:"feedback",body:a.outro,next_scene:a.next_scene},c.sequence.push(f.Plot.wrapSequence(d)),f.scope.goToNextSequence()):void 0},this.scope.getSceneBgs=function(){var a,b,c,d,e;if(null!=f.bgs)return f.bgs;if(null==f.scene||!f.scene.decor)return[];for(f.bgs=[{src:f.scene.decor[0].background,sequence:-1}],e=f.scene.sequence,a=c=0,d=e.length;d>c;a=++c)b=e[a],b.isNewBg()&&f.bgs.push({src:b.body,sequence:a});return f.bgs},this.scope.shouldDisplayBg=function(a){var b,c,d,e,g,h,i;if(e=!1,f.User.isStartingChapter())return-1===a.sequence;for(i=_.map(f.bgs,function(a){return a.sequence}),g=0,h=i.length;h>g;g++)c=i[g],c<=f.User.sequence&&(b=c);return d=f.Plot.sequence(f.chapter.id,f.scene.id,a.sequence),e=0===a.sequence||a.sequence===b,d&&d.hasConditions()&&(e=f.User.userMeetSequenceConditions(d)),e=f.User.isSummary?e&&f.User.lastScene===f.scene.id&&f.chapter.id===f.User.lastChapter:e&&f.User.scene===f.scene.id},this.scope.toggleVoicetrack=this.Sound.toggleVoicetrack,this.getLastDialogIdx=this.scope.getLastDialogIdx=function(){var a,b,c,d;for(a=f.User.chapter,b=f.User.scene,d=f.User.sequence;;){if(c=f.Plot.sequence(a,b,d),0>=d||null==c||c.hasExit())break;d--}return d}}return a.$inject=["$scope","Plot","User","Sound","Timeout","constant.characters"],a}(),angular.module("spin.controller").controller("SceneCtrl",SceneCtrl),WelcomeCtrl=function(){function a(a,b,c){var d=this;this.scope=a,this.User=b,this.timeout=c,this.scope.user=this.User,this.scope.email=this.User.email,this.token=this.User.token,this.scope.showHeadphone=this.scope.showControl=!1,this.guideStepDelay=4e3,this.scope.submit=function(){return d.User.email=d.scope.email,d.User.inGame=!0},this.scope.isNewUser=function(){return null==d.token},this.scope.startGame=function(a){return null==a&&(a=!0),a?(d.scope.showHeadphone=!0,d.timeout(function(){return d.scope.showControl=!0,d.timeout(function(){return d.User.inGame=!0},d.guideStepDelay),d.timeout(function(){return d.scope.showHeadphone=d.scope.showControl=!1},2*d.guideStepDelay)},d.guideStepDelay)):d.User.inGame=!0},this.scope.newGame=function(){return d.User.newUser(),d.User.inGame=!0},this.scope.shouldShowWelcome=function(){return!d.User.inGame&&!d.User.isGameDone}}return a.$inject=["$scope","User","$timeout"],a}(),angular.module("spin.controller").controller("WelcomeCtrl",WelcomeCtrl),angular.module("spin.directive").directive("chapter",function(){return{restrict:"E",replace:!1,templateUrl:"partials/chapter.html",controller:"ChapterCtrl",scope:{src:"="}}}),angular.module("spin.directive").directive("circle",[function(){return{restrict:"A",replace:!1,scope:{percentage:"="},link:function(a,b,c){var d,e;return e=c.id||"dk-circles-id-"+a.$id,b.attr("id",e),d=function(){var b;return b={id:e,percentage:parseFloat(a.percentage).toFixed(2),radius:parseInt(c.radius,10)||50,width:parseInt(c.width,10)||10,colors:c.colors?c.colors.split(","):["#D3B6C6","#4B253A"],duration:parseInt(c.duration,10)||null,number:" "},null!=c.text&&(b.text=c.text),window.Circles.create(b)},a.percentage?d():a.$watch(function(){return a.percentage},function(){return d()})}}}]),angular.module("spin.directive").directive("cover",function(){return{restrict:"A",replace:!1,link:function(a,b,c){var d,e,f,g;return d=g=parseInt(c.minWidth),f=parseInt(c.minHeight),e=function(){var a,c,e;return c=jQuery(window).width()/g,e=jQuery(window).height()/f,a=c>e?c:e,d>a*g&&(a=d/g),jQuery(b).width(a*g),jQuery(b).height(a*f)},jQuery(window).on("resize",e),e()}}}),angular.module("spin.directive").directive("debugToolbar",["Plot","User",function(a,b){return{restrict:"E",replace:!0,templateUrl:"partials/debug-toolbar.html",scope:!1,controller:["$scope","User",function(a,b){return a.update=function(){var c;return c=[a.inputChapter,a.inputScene,a.inputSequence],b.chapter=c[0],b.scene=c[1],b.sequence=c[2],b.eraseCareerSinceNow(),b.updateCareer()},a.gameOver=function(){return b.isGameOver=!b.isGameOver},a.gameDone=function(){return b.isGameDone=!b.isGameDone,b.inGame=!b.isGameDone},a.restartGame=function(){return b.newUser()},a.restartCurrentChapter=function(){return b.restartChapter()}}],link:function(a){return a.$watch(function(){return b.chapter},function(b){return a.inputChapter=b}),a.$watch(function(){return b.scene},function(b){return a.inputScene=b}),a.$watch(function(){return b.sequence},function(b){return a.inputSequence=b}),a.hidden=!0}}}]),angular.module("spin.directive").directive("keyboardNavigation",["$rootScope","KeyboardCommands",function(a,b){return{restrict:"A",link:function(c,d){return d.bind("keyup",function(c){var d;return d=b.get(c.which),"function"==typeof d?(a.safeApply(function(){return d(c)}),c.preventDefault(),!1):void 0})}}}]),angular.module("spin.directive").directive("href",function(){return{compile:function(a){var b;return b=""+a[0].hostname,null!=b&&b!==""+window.location.hostname?a.attr("target","_blank"):void 0}}}),angular.module("spin.directive").directive("preload",["$timeout",function(a){return{restrict:"E",scope:{images:"&",object:"="},link:function(b,c,d){var e,f;return e=function(){return 0>=f?(b.$broadcast("imagesPreloaded"),b.object[d.attr]=!0):void 0},f=0,b.object[d.attr]=!1,angular.forEach(b.images(),function(a){var b;return b=new Image,10>f&&(f++,b.onerror=b.onload=function(){return f--,e()}),b.src=a}),e(),a(function(){return f=0,e()},3e4)}}}]),angular.module("spin.directive").directive("scatterPlot",["Plot","User",function(a,b){return{replace:!0,restrict:"E",scope:{results:"=",point:"@"},transclude:!0,templateUrl:"partials/scatter-plot.html",link:function(a){var c,d,e,f,g,h;return c={horizontal:{key:"guilt",names:{max:"non coupable",min:"coupable"}},vertical:{key:"honesty",names:{max:"aveux",min:"mensonges"}}},a.axes=c,a.allPoints=function(){return a.points||[]},a.getDotStyle=function(a){return{left:""+a.left+"%",top:""+a.top+"%"}},h=function(){return{user:!0,guilt:b.indicators.guilt,honesty:b.indicators.honesty}},f=function(a,b){return _.min(a,function(a){return a[b]})[b]},e=function(a,b){return _.max(a,function(a){return a[b]})[b]},d=function(){var a,b;for(a=0,b=[];75>a;)b.push({guilt:Math.floor(100*Math.random()),honesty:Math.floor(100*Math.random())}),a++;return b},g=function(b){var f;return f=function(a){var b,d;return d={guilt:{max:e(a,"guilt")},honesty:{max:e(a,"honesty")}},b=function(a){var b,e,f,g,h,i;return b=c.horizontal.key,i=c.vertical.key,e=d[b],g=d[i],f=100-100*a[b]/e.max,h=100-100*a[i]/g.max,_.extend(a,{left:Math.floor(f),top:Math.floor(h)})},_.map(a,b)},b.length<1&&(b=d()),b.push(h()),a.points=f(b)},a.$watch(function(){return a.$eval("results")},g)}}}]),angular.module("spin.directive").directive("scene",function(){return{restrict:"E",replace:!1,templateUrl:"partials/scene.html",controller:"SceneCtrl",scope:{src:"=",chapter:"="}}}),angular.module("spin.directive").directive("screenHeight",["$window",function(a){return function(b,c,d){var e,f;return e="screenHeight resize",f=function(){return c.css("height",a.innerHeight),isNaN(d.screenHeight)?void 0:c.css("min-height",1*d.screenHeight)},f(),angular.element(a).bind(e,f),b.$on("$destroy",function(){return angular.element(a).unbind(e)})}}]),angular.module("spin.directive").directive("scrollbar",function(){return{restrict:"AE",link:function(a,b,c){return b.jScrollPane({autoReinitialise:!0,hideFocus:!0,mouseWheelSpeed:20,verticalDragMinHeight:10}),null!=c.scrollbar?b.on("jsp-scroll-y",function(b,d,e,f){return f?a.$apply(c.scrollbar):void 0}):void 0},template:'<div class="scrollbar"><div ng-transclude></div></div>',transclude:!0}}),angular.module("spin.filter").filter("checkmark",function(){return function(a){return a?"✓":"✘"}}),angular.module("spin.filter").filter("media",["constant.settings",function(a){return function(b){return a.mediaUrl+b}}]),angular.module("spin.filter").filter("minutes",function(){return function(a){var b,c;return isNaN(a)&&(a=0),b=Math.floor(a/60),c=Math.round(a-60*b),b=("0"+b).slice(-2),c=("0"+c).slice(-2),""+b+":"+c}}),angular.module("spin.filter").filter("range",function(){return function(a,b){var c;for(b=parseInt(b),c=0;b>c;)a.push(c++);return a}}),angular.module("spin.service").factory("KeyboardCommands",function(){var a;return new(a=function(){function a(){this.get=__bind(this.get,this),this.listCommands=__bind(this.listCommands,this),this.unregister=__bind(this.unregister,this),this.register=__bind(this.register,this),this.list={}}return a.prototype.register=function(a,b){var c,d=this;return c=function(a,b){return d.list[a]=b},typeof a==typeof[]?_.each(a,function(a){return c(a,b)}):c(a,b)},a.prototype.unregister=function(a){var b,c=this;return b=function(a){return null!=c.list[a]?(c.list[a]=void 0,delete c.list[a]):void 0},typeof a==typeof[]?_.each(a,function(a){return b(a)}):b(a)},a.prototype.listCommands=function(){return this.list},a.prototype.get=function(a){return this.listCommands()[a]},a}())}),angular.module("spin.service").factory("Plot",["$http","constant.api","constant.settings","constant.characters","constant.types",function(a,b,c,d,e){var f;return new(f=function(){function f(){this.sequence=__bind(this.sequence,this),this.scene=__bind(this.scene,this),this.chapter=__bind(this.chapter,this),this.wrapChapters=__bind(this.wrapChapters,this),this.wrapSequence=__bind(this.wrapSequence,this);var c=this;return this.chapters=[],a.get(b.plot).success(function(a){return c.chapters=c.wrapChapters(a)}),this}return f.prototype.sequenceWrappingObject={_wrapped:!0,lowerType:function(){return this.type.toLowerCase()},isDialog:function(){return c.sequenceDialog.indexOf(this.lowerType())>-1},isSkipped:function(){return c.sequenceSkip.indexOf(this.lowerType())>-1},isChoice:function(){return this.lowerType()===e.sequence.choice},isPlayer:function(){return this.lowerType()===e.sequence.player},isVideo:function(){return this.lowerType()===e.sequence.video},isNewBg:function(){return this.lowerType()===e.sequence.newBackground},isVideoBg:function(){return this.lowerType()===e.sequence.videoBackground},isGameOver:function(){return this.lowerType()===e.sequence.gameOver},isNotification:function(){return this.lowerType()===e.sequence.notification},isNotificationWithButton:function(){return this.lowerType()===e.sequence.notification&&this.next_button},isFeedback:function(){return this.lowerType()===e.sequence.feedback},hasConditions:function(){return null!=this.condition},hasNext:function(){return c.sequenceWithNext.indexOf(this.lowerType())>-1},hasExit:function(){return this.isPlayer()||this.isDialog()||this.isChoice()||this.isFeedback()||this.isNotificationWithButton()},getEmbedSrc:function(){var a;return a=-1!==navigator.userAgent.toLowerCase().indexOf("safari"),a||(this.body=this.body.replace("&html=1","")),this.body=this.body.replace("dailymotion.com/video/","dailymotion.com/embed/video/")},getHeadSrc:function(){var a;return null!=this.character?(a=this.character.toLowerCase().replace(/[^\w-]+/g,""),d[a]):void 0}},f.prototype.wrapSequence=function(a){return a=a||{type:""},a._wrapped||(a=_.extend(a,this.sequenceWrappingObject)),a},f.prototype.wrapChapters=function(a){var b,c,d,e,f,g,h;for(d=0,f=a.length;f>d;d++)for(b=a[d],h=b.scenes,e=0,g=h.length;g>e;e++)c=h[e],c.sequence=_.map(c.sequence,this.wrapSequence);return a},f.prototype.chapter=function(a){return _.find(this.chapters||[],function(b){return b.id===a})},f.prototype.scene=function(a,b){var c;return c=this.chapter(a)||{},_.find(c.scenes||[],function(a){return a.id===b})},f.prototype.sequence=function(a,b,c){var d;return d=this.scene(a,b)||{sequence:[]},d.sequence[c]},f}())}]),angular.module("spin.service").factory("Progression",["$rootScope","$timeout","constant.keys","constant.doors","Plot","User","Sound","Timeout","KeyboardCommands",function(a,b,c,d,e,f,g,h,i){var j;return new(j=function(){function j(){this.singMeTheEnd=__bind(this.singMeTheEnd,this),this.onKeyPressed=__bind(this.onKeyPressed,this),this.onInGameChanged=__bind(this.onInGameChanged,this),this.onSceneChanged=__bind(this.onSceneChanged,this);a.$watch(function(){return f.inGame},this.onInGameChanged,!0),a.$watch(function(){return f.isGameOver},function(a){return a===!1&&f.gameOverReason?f.gameOverReason=void 0:void 0}),a.$watch(function(){return f.chapter},this.onChapterChanged,!0),a.$watch(function(){return f.scene},this.onSceneChanged,!0),a.$watch(function(){return f.isReady},f.saveChapterChanging,!0),a.$watch(function(){return f},f.updateLocalStorage,!0),a.$watch(function(){return[e.chapters,f.scene]},function(){return f.inGame?g.startScene():void 0},!0),a.$watch(function(){return f.scene+f.sequence},function(){return f.inGame?(h.toggleSequence(),g.toggleSequence()):void 0}),a.$watch(function(){return f.isStartingChapter()},function(){return g.toggleSequence()}),a.$watch(function(){return f.isGameOver},function(a,b){return a&&!b?(g.stopVoiceTrack(),h.cancel()):void 0}),a.$watch(function(){return f.volume},g.updateVolume),a.$watch(function(){return f.isGameDone},this.singMeTheEnd,!0),i.register(c.next,this.onKeyPressed)}return j.prototype.onChapterChanged=function(a,b){var c,d,g,h;return c=function(a){return parseInt(a)},h=!1,d=e.chapter(a),g=e.chapter(b),h=a>b&&g&&g.bilan,h?f.isSummary=!0:f.saveChapterChanging(a),f.lastChapter=b},j.prototype.onSceneChanged=function(a,b){return f.lastScene=b},j.prototype.onInGameChanged=function(){return f.isGameDone?g.stopTracks(!0,!1):(g.startScene(),f.saveChapterChanging(!0))},j.prototype.onKeyPressed=function(){var a,b,c,d,g;return b=f.inGame,d=f.isSummary,a=f.isGameOver,c=f.isStartingChapter(),_.every([b,!d,!a,!c])&&(g=e.sequence(f.chapter,f.scene,f.sequence),g.hasNext()&&f.nextSequence()),d&&b&&!a?f.leaveSummary():void 0},j.prototype.singMeTheEnd=function(a){var c,e,f,g,h,i,j;if("undefined"!=typeof console&&null!==console&&console&&a){for(c=0,i=d.theEnd,j=[],g=0,h=i.length;h>g;g++)f=i[g],e=3500*c,b(function(a){return function(){return console.log(a)}}(f),e),j.push(c++);return j}},j}())}]),angular.module("spin.service").factory("Results",["User","Plot","constant.api","$q","$rootScope","$http",function(a,b,c,d,e,f){var g;return new(g=function(){function g(){this.wrapSceneResult=__bind(this.wrapSceneResult,this),this.wrapResults=__bind(this.wrapResults,this),this.unsentenceIt=__bind(this.unsentenceIt,this),this.get=__bind(this.get,this),this.getPreviousResults=__bind(this.getPreviousResults,this);var c=this;this.list=this.list||{},e.$watch(function(){return b.chapters.length},function(){return parseInt(a.chapter)>1?c.getPreviousResults():void 0})}return g.prototype.API_URL=c.results,g.prototype.STARTS_WITH_CAPITAL=/^[A-Z]/,g.prototype.getPreviousResults=function(){var c;return c=_.filter(b.chapters,function(b){return parseInt(b.id)<parseInt(a.chapter)&&b.bilan}),_.map(c,this.get)},g.prototype.get=function(b){var c,e,g,h=this;return c=d.defer(),g=this.list[b.id],null!=g?c.resolve(g):(e=f.get(this.API_URL,{params:{chapter:b.id,token:a.token}}),e.success(function(a){var d;return h.list[b.id]=d=h.wrapResults(a,b),c.resolve(d)}),e.error(function(a){var d;return d=["An error occured while getting results of chapter"," "+b.id+":"],c.reject(d),console.warn(d.join(""),a)})),c.promise},g.prototype.unsentenceIt=function(a){return this.STARTS_WITH_CAPITAL.test(a)&&(a=a.replace(a[0],a[0].toLowerCase())),a},g.prototype.wrapResults=function(a,b){var c,d,e,f;c={share_sentence:a.share_sentence,chapter:b,list:{}},f=a.scenes;for(e in f)d=f[e],c.list[e]=this.wrapSceneResult(d);return c},g.prototype.wrapSceneResult=function(a){var b,c,d,e,f,g;return null!=a.you&&(g=a.you),b=a.options[g],null!=b?(c=b.percentage,f=this.unsentenceIt(b.title),e={userChoice:b,percentage:{sentence:"Comme <b>"+Math.round(c)+"%</b> des utilisateurs précédents, "+f,raw:c,style:{width:""+Math.round(c)+"%"}}},d=_.extend(a,e)):d=a,d},g}())}]),angular.module("spin.service").factory("Sound",["User","Plot","$rootScope","$filter",function(a,b,c,d){var e;return new(e=function(){function e(){this.updateVolume=__bind(this.updateVolume,this),this.stopTracks=__bind(this.stopTracks,this),this.toggleVoicetrack=__bind(this.toggleVoicetrack,this),this.toggleSequence=__bind(this.toggleSequence,this),this.startScene=__bind(this.startScene,this),this.stopVoiceTrack=__bind(this.stopVoiceTrack,this),this.extractAllTracks=__bind(this.extractAllTracks,this),this.startSoundTrack=__bind(this.startSoundTrack,this)}return e.prototype.startSoundTrack=function(b){var d=this;return null!=this.soundtrack&&(this.soundtrack.stop(),this.soundtrack=void 0),this.soundtrack=new Howl({urls:b,loop:!0,buffer:!0,volume:0,onplay:function(){return c.safeApply(function(){return d.soundtrack.isPlaying=!0
})},onpause:function(){return c.safeApply(function(){return d.soundtrack.isPlaying=!1})},onend:function(){return c.safeApply(function(){return d.soundtrack.isPlaying=!1})}}),this.soundtrack.play(function(){return d.soundtrack.fade(0,a.volume,1e3)})},e.prototype.extractAllTracks=function(a){var b;return b=[a],b.push(b[0]),b[1]=b[1].split("."),b[1][b[1].length-1]="ogg",b[1]=b[1].join("."),b},e.prototype.stopVoiceTrack=function(a){return null==a&&(a=null),null!=this.voicetrack?(clearInterval(this.voicetrack._interval),null!=a&&"notification"===a.type?this.voicetrack.pause():(this.voicetrack.stop(),this.voicetrack=null)):void 0},e.prototype.startScene=function(c,e){var f,g=this;if(null==c&&(c=a.chapter),null==e&&(e=a.scene),null!=this.notificationtrack&&(this.notificationtrack.stop(),this.notificationtrack=null),this.stopVoiceTrack(),null!=e&&b.chapters.length&&null!=b.scene(c,e)&&(e=b.scene(c,e),f=this.extractAllTracks(d("media")(e.decor[0].soundtrack)),e.decor[0].hasOwnProperty("soundtrack")))if(null!=e.decor[0].soundtrack){if(null==this.soundtrack)return this.startSoundTrack(f);if(!angular.equals(this.soundtrack.urls(),f))return this.soundtrack.fade(a.volume,0,1e3,function(){return g.startSoundTrack(f)})}else if(null!=this.soundtrack)return this.soundtrack.fade(this.soundtrack.volume(),0,1e3,function(){return g.soundtrack.stop(),g.soundtrack=void 0})},e.prototype.toggleSequence=function(e,f,g){var h,i,j=this;if(null==e&&(e=a.chapter),null==f&&(f=a.scene),null==g&&(g=a.sequence),null!=g){if(h=b.sequence(e,f,g),null!=this.notificationtrack&&(this.notificationtrack.stop(),this.notificationtrack=null),this.stopVoiceTrack(h),null!=this.soundtrack&&this.soundtrack.volume()<a.volume&&this.soundtrack.fade(this.soundtrack.volume(),a.volume,500),a.isStartingChapter())return;if(null!=h&&"voixoff"===h.type){if(i=this.extractAllTracks(d("media")(h.body||h.sound)),null==this.voicetrack||!angular.equals(this.voicetrack.urls(),i))return this.voicetrack=new Howl({urls:i,loop:!1,buffer:!0,volume:0,autoplay:!1,onload:function(){return j.voicetrack.play(),j.voicetrack._interval=setInterval(function(){return j.voicetrack._position=j.voicetrack.pos()||0,function(){return null!=j.voicetrack&&j.voicetrack.isPlaying?c.safeApply(function(){return j.voicetrack._position=j.voicetrack.pos()}):void 0}}(),500)},onplay:function(){return c.safeApply(function(){var b;return null!=j.soundtrack&&(j.soundtrack.fade(j.soundtrack.volume(),a.volume/4,500),b=0===j.soundtrack.pos()?1e3:0),j.voicetrack.fade(0,1,b),j.voicetrack.isPlaying=!0})},onpause:function(){return c.safeApply(function(){return j.voicetrack.isPlaying=!1})},onend:function(){return c.safeApply(function(){return null!=j.soundtrack&&j.soundtrack.fade(j.soundtrack.volume(),a.volume,500),c.safeApply(function(){return j.voicetrack._position=j.voicetrack._duration}),j.voicetrack.pos(0),j.voicetrack.isPlaying=!1,clearInterval(j.voicetrack._interval),a.nextSequence()})}});if(null!=this.voicetrack&&!this.voicetrack.isPlaying)return this.voicetrack.play();if(null!=this.voicetrack&&null!=this.voicetrack.isPlaying)return this.voicetrack.pause()}else if(null!=h&&("notification"===h.type||"choice"===h.type&&null!=h.delay))return i=this.extractAllTracks(d("media")(h.sound)),this.notificationtrack=new Howl({urls:i,loop:!1,buffer:!0,volume:1,autoplay:!0,onplay:function(){return c.safeApply(function(){return j.notificationtrack.isPlaying=!0})},onpause:function(){return c.safeApply(function(){return j.notificationtrack.isPlaying=!1})},onend:function(){return c.safeApply(function(){return j.notificationtrack.isPlaying=!1})}})}},e.prototype.toggleVoicetrack=function(){return null!=this.voicetrack?this.voicetrack.isPlaying?(this.voicetrack.pause(),this.voicetrack.isPlaying=!1):(this.voicetrack.play(),this.voicetrack.isPlaying=!0):void 0},e.prototype.stopTracks=function(a,b){return null==a&&(a=!0),null==b&&(b=!0),a&&null!=this.voicetrack&&this.voicetrack.stop(),b&&null!=this.soundtrack?this.soundtrack.stop():void 0},e.prototype.updateVolume=function(a){return null!=a&&null!=this.soundtrack?this.soundtrack.volume(a):void 0},e}())}]),angular.module("spin.service").service("ThirdParty",["$http","$window",function(a,b){var c;return new(c=function(){function a(){this.shareOnGplus=__bind(this.shareOnGplus,this),this.shareOnTwitter=__bind(this.shareOnTwitter,this),this.shareOnFacebook=__bind(this.shareOnFacebook,this),this.url="http://www.jeudinfluences.fr/"}return a.prototype.shareOnFacebook=function(a){var c;return null==a&&(a=this.url),c="https://www.facebook.com/sharer/sharer.php?u="+a+"&display=popup",b.open(c,"shareOnFacebook","menubar=no, status=no, scrollbars=no, menubar=no, width=670, height=370"),!0},a.prototype.shareOnTwitter=function(a){var c,d;return null==a&&(a=this.url),d="Jusqu'ici j'ai fait les bons choix, je gère la crise. Et vous, quels seraient les vôtres ? {URL} #jeudinfluences",d=d.replace("{URL}",this.url),d=encodeURIComponent(d),c="https://twitter.com/share?&text="+d+"&url=&",b.open(c,"shareOnTwitter","menubar=no, status=no, scrollbars=no, menubar=no, width=550, height=380"),!0},a.prototype.shareOnGplus=function(a){var c;return null==a&&(a=this.url),c="https://plus.google.com/share?url="+a,b.open(c,"shareOnGplus","menubar=no, status=no, scrollbars=no, menubar=no, width=600, height=600"),!0},a}())}]),angular.module("spin.service").factory("Timeout",["$rootScope","User","Plot","TimeoutStates","constant.settings","$timeout",function(a,b,c,d,e,f){var g;return new(g=function(){function a(){this.timeStep=__bind(this.timeStep,this),this.toggleSequence=__bind(this.toggleSequence,this),this.cancel=__bind(this.cancel,this),this.states=d,this.remainingTime=0,this._lastStep=null,this._timeout=void 0}return a.prototype.cancel=function(){return f.cancel(this._timeout),this._timeout=void 0,this.remainingTime=0,this._lastStep=null},a.prototype.toggleSequence=function(a,g,h){if(null==a&&(a=b.chapter),null==g&&(g=b.scene),null==h&&(h=b.sequence),null!=h){if(null!=this._timeout&&(this.remainingTime=0,f.cancel(this._timeout),this._timeout=void 0,this._lastStep=null),this.sequence=c.sequence(a,g,h),null==this.sequence)return;if(this.sequence.isChoice()&&null!=this.sequence.delay)return this.remainingTime=0,this._timeout=f(this.timeStep,e.timeoutRefRate),this._lastStep=Date.now();if(this.sequence.isFeedback())return void 0!==d.feedback&&(f.cancel(d.feedback),d.feedback=void 0),d.feedback=f(function(a){return function(){return b.goToScene(a.next_scene)}}(this.sequence),e.feedbackDuration)}},a.prototype.timeStep=function(){var a,c,d;if(null!=this._timeout&&(a=Date.now(),this.remainingTime+=(a-this._lastStep)*(100/(1e3*this.sequence.delay)),!isNaN(this.remainingTime)))return this.remainingTime<100?(this._timeout=f(this.timeStep,e.timeoutRefRate),this._lastStep=a):(this._timeout=void 0,d=0,null!=this.sequence.default_option&&(d=this.sequence.default_option-1),c=this.sequence.options[d],this.remainingTime=0,this._lastStep=null,b.updateCareer({choice:d,scene:b.pos()}),b.goToScene(c.next_scene))},a}())}]),angular.module("spin.service").factory("TimeoutStates",[function(){var a;return new(a=function(){function a(){this.feedback=void 0}return a}())}]),angular.module("spin.service").factory("User",["constant.api","constant.settings","constant.types","TimeoutStates","UserIndicators","Plot","localStorageService","$http","$timeout","$location","$rootScope",function(a,b,c,d,e,f,g,h,i,j,k){var l;return new(l=function(){function l(){this.eraseCareerChapter=__bind(this.eraseCareerChapter,this),this.eraseCareerSinceNow=__bind(this.eraseCareerSinceNow,this),this.leaveSummary=__bind(this.leaveSummary,this),this.restartChapter=__bind(this.restartChapter,this),this.restart=__bind(this.restart,this),this.goToScene=__bind(this.goToScene,this),this.associate=__bind(this.associate,this),this.userMeetSequenceConditions=__bind(this.userMeetSequenceConditions,this),this.isSequenceConditionOk=__bind(this.isSequenceConditionOk,this),this.nextSequence=__bind(this.nextSequence,this),this.updateCareer=__bind(this.updateCareer,this),this.createNewCareer=__bind(this.createNewCareer,this),this.loadCareer=__bind(this.loadCareer,this),this.chapterTrackingLoop=__bind(this.chapterTrackingLoop,this),this.saveChapterChanging=__bind(this.saveChapterChanging,this),this.isStartingChapter=__bind(this.isStartingChapter,this),this.checkProgression=__bind(this.checkProgression,this),this.updateProgression=__bind(this.updateProgression,this),this.updateLocalStorage=__bind(this.updateLocalStorage,this),this.newUser=__bind(this.newUser,this),this.chapterProgression=__bind(this.chapterProgression,this),this.pos=__bind(this.pos,this),this.setInitialValues=__bind(this.setInitialValues,this);var a,b=this;return a=g.get("user")||{},this.setInitialValues(a),this.token=j.search().token||a.token||null,this.email=a.email||null,null!=j.search().token&&(null===this.email&&(this.email=!0),j.search("token",null)),null!==this.token&&this.loadCareer(),k.$watch(function(){return b.inGame},function(a,c){return null===b.token&&a&&!c?b.loadCareer():void 0},!0),this}return l.prototype.setInitialValues=function(a){var b,c,d=this;return null==a&&(a={}),this.scenes=a.scenes||[],this.volume=isNaN(a.volume)?1:a.volume,b=[null,null],this.token=b[0],this.email=b[1],this.inGame=this.isGameOver=this.isGameDone=this.isSummary=this.isReady=!1,c=["1","1",0],this.chapter=c[0],this.scene=c[1],this.sequence=c[2],this.indicators={stress:e.stress.meta.start,trust:e.trust.meta.start,ubm:e.ubm.meta.start,guilt:0,honesty:0,karma:0},k.$watch(function(){return d.inGame},function(a,b){return a&&!b?d.loadCareer():void 0},!0),this},l.prototype.pos=function(){return this.chapter+"."+this.scene},l.prototype.chapterProgression=function(){var a;return this.isSummary?100:(a=_.intersection(b.mainScenes[this.chapter],this.scenes),Math.round(Math.min(a.length,4)/4*100))},l.prototype.newUser=function(){return g.clearAll(),this.setInitialValues()},l.prototype.updateLocalStorage=function(a){return null==a&&(a=this),null!=a?g.set("user",a):void 0},l.prototype.updateProgression=function(a){var b,c,e,f;if(null!=a.reached_scene&&"string"==typeof a.reached_scene&&void 0===d.feedback){e=a.reached_scene.split("."),this.chapter=e[0],this.scene=e[1],this.scenes=a.scenes,f=a.context;for(b in f)__hasProp.call(f,b)&&(c=f[b],this.indicators[b]=c);this.sequence=0,this.isSequenceConditionOk()||this.nextSequence()}return this.checkProgression()?this.isGameOver=!0:void 0},l.prototype.checkProgression=function(){var a,b,c,d;if(this.inGame){a=!1,d=this.indicators;for(b in d)if(c=d[b],null!=e[b]&&e[b].isGameOver(c)){this.gameOverReason=b,a=!0;break}return a}},l.prototype.isStartingChapter=function(){return Date.now()-this.lastChapterChanging<b.chapterEntrance||!this.isReady},l.prototype.saveChapterChanging=function(a){return null!=a?(this.lastChapterChanging=Date.now(),null!=this.trackChapterChanging&&i.cancel(this.trackChapterChanging),this.chapterTrackingLoop()):void 0},l.prototype.chapterTrackingLoop=function(){return this.isStartingChapter()||null==this.trackChapterChanging?this.trackChapterChanging=i(this.chapterTrackingLoop,200):i.cancel(this.trackChapterChanging)},l.prototype.loadCareer=function(){var b=this;return null!=this.token?h.get(""+a.career+"?token="+this.token).success(this.updateProgression).error(function(){return null!=b.token||null!=b.email?b.newUser():void 0}):this.createNewCareer(null!=this.email)},l.prototype.createNewCareer=function(b){var c=this;return null==b&&(b=!1),h.post(""+a.career,{reached_scene:"1.1"}).success(function(a){return c.token=a.token,b&&c.associate(c.email),c.loadCareer()})},l.prototype.updateCareer=function(b){var c,d,e,g,i,j;return this.token?(null!=b?(i=b,j=b.scene.split("."),c=j[0],e=j[1],g=f.sequence(c,e,this.sequence),null!=g.options&&(d=g.options[b.choice],i.reached_scene=d.next_scene)):i={reached_scene:this.pos()},i.is_game_done=this.isGameDone,h.post(""+a.career+"?token="+this.token,i).success(this.updateProgression)):!1},l.prototype.nextSequence=function(){var a,b,c,d,e,g,h;if(d=f.scene(this.chapter,this.scene),c=f.sequence(this.chapter,this.scene,this.sequence),c.result&&this.isSequenceConditionOk(c)){h=c.result;for(b in h)g=h[b],this.indicators[b]+=g,a=this.checkProgression(),a&&(this.isGameOver=!0)}return this.isGameOver||(null!=f.sequence(this.chapter,this.scene,this.sequence+1)?(++this.sequence,e=f.sequence(this.chapter,this.scene,this.sequence),this.isSequenceConditionOk(e)||(e=this.nextSequence())):d&&null!=d.next_scene&&(this.goToScene(d.next_scene),e=f.sequence(this.chapter,this.scene,this.sequence))),e},l.prototype.isSequenceConditionOk=function(a){var b,c=this;return a=a||f.sequence(this.chapter,this.scene,this.sequence),null==a?!0:(b=this.userMeetSequenceConditions(a),a.isSkipped()&&(b=!1),a.isGameOver()&&k.safeApply(function(){return c.isGameOver=!0}),b)},l.prototype.userMeetSequenceConditions=function(a){var b,c,d,e,g;if(b=!0,a=a||f.sequence(this.chapter,this.scene,this.sequence),null==a)return!0;if(a.condition){g=a.condition;for(c in g)e=g[c],d=this.indicators[c],null==d&&(d=!1),b=b&&d===e}return b},l.prototype.associate=function(b){return null!=b&&""!==b?h({url:""+a.associate+"?token="+this.token,method:"POST",data:{email:b}}):void 0},l.prototype.goToScene=function(a,b){var e,g,h,i,j,k,l,m;return null==b&&(b=!0),d.feedback&&(d.feedback=void 0),"string"==typeof a?i=a:(h=this.indicators.karma>=0?"positif":"negatif",i=a[""+h+"_karma"]),i===c.scene.theEnd?(this.isGameDone=!0,this.inGame=!1,this.singMeTheEnd(),void(b&&this.updateCareer())):(l=i.split("."),e=l[0],j=l[1],k=function(a){return console.warn(""+a+" doesn't exist ("+i+").")},null==f.chapter(e)?k("Chapter"):null==f.scene(e,j)?k("Scene"):this.chapter===e&&this.scene===j?null==f.sequence(e,j,this.sequence+1)?k("Next sequence"):this.nextSequence():(g=this.checkProgression(),!g&&(m=[e,j,0],this.chapter=m[0],this.scene=m[1],this.sequence=m[2],this.isSequenceConditionOk()||this.nextSequence(),b)?this.updateCareer():void 0))},l.prototype.restart=function(){return this.inGame=this.isSummary=this.isGameDone=this.isGameOver=!1,this.newUser()},l.prototype.restartChapter=function(){return this.inGame=!0,this.isSummary=!1,this.isGameOver=!1,this.eraseCareerChapter().success(this.updateProgression)},l.prototype.leaveSummary=function(){return this.isSummary=!1,this.saveChapterChanging(!0)},l.prototype.eraseCareerSinceNow=function(){return h({url:""+a.erase+"?token="+this.token,method:"POST",data:{since:this.chapter+"."+this.scene}})},l.prototype.eraseCareerChapter=function(){return h({url:""+a.erase+"?token="+this.token,method:"POST",data:{chapter:this.chapter}})},l}())}]),assert=function(a){if(!a)throw"Assertion failed"},angular.module("spin.service").factory("UserIndicators",["constant.indicators",function(a){var b;return new(b=function(){function b(){this.bindIndicators=__bind(this.bindIndicators,this),this.bindRules=__bind(this.bindRules,this),this.bindRules(a.meta.rules),this.bindIndicators(a.all)}return b.prototype.bindRules=function(a){return this.genericFunctions=this.genericFunctions||{},this.genericFunctions[a.lessThanOrEqual]=function(a,b){return b>=a},this.genericFunctions[a.lessThan]=function(a,b){return b>a},this.genericFunctions[a.greaterThanOrEqual]=function(a,b){return a>=b},this.genericFunctions[a.greaterThan]=function(a,b){return a>b}},b.prototype.bindIndicators=function(a){var b,c,d,e,f,g;g=[];for(f in a)e=a[f],b=e.gameOver.rule,c=e[e.gameOver.on],d=this.genericFunctions[b],g.push(this[f]={meta:e,gameOverFunction:d,gameOverValue:c,isGameOver:function(a){return this.gameOverFunction(a,this.gameOverValue)}});return g},b}())}]),angular.module("spin.service").service("Xiti",["$rootScope","User","Plot","constant.xiti",function(a,b,c,d){var e;return new(e=function(){function e(){this.loadPage=__bind(this.loadPage,this),this.updateConfig=__bind(this.updateConfig,this),this.watchInGame=__bind(this.watchInGame,this),this.watchIf=__bind(this.watchIf,this);var a=this;this.currentPage="home",this.watchInGame(function(){return[b.inGame,b.chapter]},function(){return a.loadPage(a.chapter())}),this.watchInGame(function(){return[b.inGame,b.scene]},function(){return a.loadPage(a.chapter())}),this.watchIf(function(){return b.isGameOver},function(a){return a},function(){return a.loadPage("game-over")}),this.watchIf(function(){return b.isGameDone},function(a){return a},function(){return a.loadPage("bilan-fin-jeu")}),this.watchIf(function(){return b.isSummary},function(a){return a},function(){return a.loadPage(a.chapter(),"bilan-fin-chapitre")})}return e.prototype.watchIf=function(b,c,d){return a.$watch(b,function(a){return c(a)?d():void 0},!0)},e.prototype.watchInGame=function(a,c){return this.watchIf(a,function(){return b.inGame},c)},e.prototype.chapter=function(){return"chapter-n"+b.chapter},e.prototype.scene=function(){return"scene-n"+b.scene},e.prototype.sequence=function(){var a;return a=c.sequence(b.chapter,b.scene,b.sequence),a&&a.isChoice()?"choice":"sequence-n"+b.sequence},e.prototype.updateConfig=function(){return null==window.xtsd&&(window.xtsd=d.xtsd),null==window.xtsite&&(window.xtsite=d.xtsite),null==window.xtn2&&(window.xtn2=d.xtn2),null==window.xtpage&&(window.xtpage="home"),null!=window.xtdi?window.xtdi:window.xtdi=""},e.prototype.loadPage=function(){var a,b,c;return a=Array.prototype.slice.call(arguments),this.currentPage!==a.join("::")&&null!=window.xt_click?(this.currentPage=a.join("::"),c=d.prefix+this.currentPage,null!=this.img&&angular.element(this.img).remove(),this.img=document.createElement("img"),this.img.height=1,this.img.width=1,b=""+window.xtsd+".xiti.com/",b+="hit.xiti?s="+window.xtsite,b+="&s2="+xtn2,b+="&p="+c,b+="&di="+window.xtdi,b+="&na="+(new Date).getTime(),this.img.src=b,angular.element("body").append(this.img)):void 0},e.prototype.track=function(a,b,c,d,e){var f;return null==c&&(c="C"),null==d&&(d="N"),null==e&&(e=window.xtn2),window.xt_click(null!=(f=a.target)?f:null,c,e,b,d),!0},e}())}]);
var ChapterCtrl,GameOverCtrl,MainCtrl,NavCtrl,ResultsCtrl,SceneCtrl,WelcomeCtrl,app,assert,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty;angular.module("spin.constant",[]),angular.module("spin.animation",["ngAnimate","spin.constant"]),angular.module("spin.config",["ngRoute","spin.constant"]),angular.module("spin.controller",["ngResource","spin.constant","spin.filter"]),angular.module("spin.directive",["ngResource","spin.constant"]),angular.module("spin.filter",["ngResource","spin.constant"]),angular.module("spin.template",["ngRoute"]),angular.module("spin.service",["ngResource","LocalStorageModule","spin.constant"]),app=angular.module("spin",["ngRoute","ngResource","ngAnimate","ngSanitize","nouislider","btford.markdown","spin.constant","spin.animation","spin.config","spin.filter","spin.service","spin.template","spin.directive"]),angular.module("spin.animation").animation(".chapter-entrance-animation",["$timeout","constant.settings",function(a,b){return{enter:function(c,d){return c.css("opacity",0),a(function(){return c.animate({opacity:1},b.chapterEntrance/3,d)},b.chapterEntrance/3),function(a){return a?jQuery(c).stop():void 0}},leave:function(a,c){return a.css("opacity",1),a.animate({opacity:0},b.chapterEntrance/3,c),function(b){return b?jQuery(a).stop():void 0}}}}]),angular.module("spin.animation").animation(".scene-entrance-animation",["$timeout","constant.settings",function(a,b){return{enter:function(a,c){return a.css("opacity",0),a.animate({opacity:1},b.sceneEntrance,c),function(b){return b?jQuery(a).stop():void 0}},leave:function(a,c){return a.css("opacity",1),a.animate({opacity:0},b.sceneEntrance,c),function(b){return b?jQuery(a).stop():void 0}}}}]),angular.module("spin.config").config(["$interpolateProvider","$httpProvider",function(a){return a.startSymbol("[["),a.endSymbol("]]")}]),angular.module("spin.config").config(["$routeProvider","$locationProvider",function(a,b){return b.html5Mode(!0),a.when("/",{templateUrl:"partials/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("spin.config").run(["$rootScope",function(a){return a.safeApply=function(a){var b;return b=this.$root.$$phase,"$apply"!==b&&"$digest"!==b?this.$apply(a):a&&"function"==typeof a?a():void 0}}]),angular.module("spin.constant").constant("constant.api",{career:"/api/career",plot:"/api/plot",associate:"/api/career/associate_email",results:"/api/summary"}),angular.module("spin.constant").constant("constant.characters",{journaliste:"/img/head/journaliste.gif",journalisteradio:"/img/head/journalisteradio.gif",louis:"/img/head/louis.gif",martinjarendeau:"/img/head/martinjarendeau.gif",nadia:"/img/head/nadia.gif",patrickluaud:"/img/head/patrickluaud.gif"}),angular.module("spin.constant").constant("constant.indicators",{meta:{rules:{lessThanOrEqual:"lte",lessThan:"lt",greaterThanOrEqual:"gte",greaterThan:"gt"}},all:{karma:{start:0,max:50,min:-50,gameOver:{on:"min",rule:"lte"}},ubm:{start:0,min:0,max:100,gameOver:{on:"max",rule:"gte"}},trust:{min:0,max:100,start:100,gameOver:{on:"min",rule:"lte"}},stress:{min:0,max:100,start:0,gameOver:{on:"max",rule:"gte"}}}}),angular.module("spin.constant").constant("constant.settings",{mediaUrl:window.MEDIA_URL||"",chapterEntrance:6e3,sceneEntrance:1e3,sequenceWithNext:["dialogue","narrative","video","notification","voixoff"],sequenceBlocking:["dialogue","narrative","voixoff","video","notification","choice"],sequenceDialog:["dialogue","narrative"],sequenceSkip:["new_background"],timeoutRefRate:100,mainScenes:{1:["1.1","1.4","1.6"],2:["2.6","2.16","2.27"],3:["3.10","3.18","3.26","3.28"],4:["4.17","4.23","4.31"],5:["5.13","5.26","5.42"],6:["6.3","6.9","6.13","6.17","6.28","6.33"]}}),angular.module("spin.constant").constant("constant.types",{sequence:{choice:"choice",player:"voixoff",newBackground:"new_background",feedback:"feedback",notification:"notification",gameOver:"gameover"}}),ChapterCtrl=function(){function a(a,b,c,d){var e=this;this.scope=a,this.Plot=b,this.User=c,this.filter=d,this.scope.plot=this.Plot,this.scope.user=this.User,this.chapter=this.scope.chapter=this.scope.src,this.scope.shouldShowChapter=function(){return e.chapter.id===e.User.chapter&&e.User.inGame},this.scope.chapterClasses=function(){return{"chapter--starting":c.isStartingChapter()}},this.scope.getBackgrounds=function(){var a;return null!=e.bgs?e.bgs:(e.bgs=[],a=e.filter("media"),angular.forEach(e.chapter.scenes,function(b){return null!=b.decor[0].background&&e.bgs.push(a(b.decor[0].background)),angular.forEach(b.sequence,function(b){return b.isNewBg()&&null!==b.body?e.bgs.push(a(b.body)):void 0})}),e.bgs)}}return a.$inject=["$scope","Plot","User","$filter"],a}(),angular.module("spin.controller").controller("ChapterCtrl",ChapterCtrl),GameOverCtrl=function(){function a(a,b){var c=this;this.scope=a,this.User=b,this.scope.user=this.User,this.scope.email=this.User.email,this.scope.submit=function(){return c.User.email=c.scope.email,c.User.inGame=!0}}return a.$inject=["$scope","User"],a}(),MainCtrl=function(){function a(a,b,c,d,e){this.scope=a,this.Progression=b,this.Plot=c,this.User=d,this.Sound=e,this.scope.plot=this.Plot,this.scope.user=this.User,this.scope.sound=this.Sound}return a.$inject=["$scope","Progression","Plot","User","Sound"],a}(),angular.module("spin.controller").controller("MainCtrl",MainCtrl),NavCtrl=function(){function a(a,b,c){var d=this;this.scope=a,this.User=b,this.ThirdParty=c,this.save=__bind(this.save,this),this.shouldShowSaveButton=__bind(this.shouldShowSaveButton,this),this.scope.user=this.User,this.scope.thirdParty=this.ThirdParty,this.scope.volume=100*this.User.volume,this.scope.isVolumeOn=function(){return d.User.volume>0},this.scope.$watch("volume",function(a){return null!=a?d.User.volume=a/100:void 0}),this.scope.shouldShowSaveButton=this.shouldShowSaveButton,this.scope.save=this.save,this._shouldShowSaveButton=!0,this.scope.$watch(function(){return b.inGame},function(a,b){return null!=d.User.email&&a&&!b?d._shouldShowSaveButton=!1:void 0}),this.scope.$watch("shouldShowSaveForm",function(a,b){return null!=d.User.email&&b&&!a?d._shouldShowSaveButton=!1:void 0})}return a.$inject=["$scope","User","ThirdParty"],a.prototype.shouldShowSaveButton=function(){return this.User.inGame&&this._shouldShowSaveButton},a.prototype.save=function(){var a,b=this;return a=this.scope.email,this.User.associate(a).success(function(){return b.User.email=a}).error(function(){})},a}(),angular.module("spin.controller").controller("NavCtrl",NavCtrl),ResultsCtrl=function(){function a(a,b,c,d,e,f){var g=this;this.scope=a,this.sce=b,this.Progression=c,this.User=d,this.Plot=e,this.Results=f,this.onChapterIndexChanged=__bind(this.onChapterIndexChanged,this),this.otherResults=__bind(this.otherResults,this),this.getAt=__bind(this.getAt,this),this.idAt=__bind(this.idAt,this),this.hasMoreResults=__bind(this.hasMoreResults,this),this.scope.plot=this.Plot,this.scope.user=this.User,this.scope.chapter=0,this.scope.shouldShowResults=function(){return g.User.isGameDone},this.scope.goNextChapter=function(){return g.scope.chapter+=1},this.scope.hasMoreResults=this.hasMoreResults,this.scope.$watch("chapter",this.onChapterIndexChanged),this.scope.$watch(function(){return _.keys(g.Results.list).length},function(a){return a>0?g.onChapterIndexChanged(g.scope.chapter):void 0})}return a.$inject=["$scope","$sce","Progression","User","Plot","Results"],a.prototype.hasMoreResults=function(){return _.isEmpty(this.getAt(this.scope.chapter+1))},a.prototype.idAt=function(a){return _.keys(this.Results.list)[a]},a.prototype.getAt=function(a){return null!=a?this.Results.get(this.idAt(a))||{}:void 0},a.prototype.otherResults=function(){return _.omit(this.Results.list,this.idAt(this.scope.chapter))},a.prototype.onChapterIndexChanged=function(a){var b,c=this;return b=this.getAt(a),this.scope.safeApply(function(){return c.scope.currentResults=b,c.scope.allOtherResults=c.otherResults()})},a}(),angular.module("spin.controller").controller("ResultsCtrl",ResultsCtrl),SceneCtrl=function(){function a(a,b,c,d,e){var f=this;this.scope=a,this.Plot=b,this.User=c,this.Sound=d,this.Timeout=e,this.scope.plot=this.Plot,this.scope.user=this.User,this.scope.sound=this.Sound,this.scope.timeout=this.Timeout,this.scene=this.scope.scene=this.scope.src,this.chapter=this.scope.chapter,this.shouldShowScene=this.scope.shouldShowScene=function(){return f.scene.id===f.User.scene},this.scope.shouldShowSequence=function(a){return f.shouldShowScene()&&!f.User.isStartingChapter()&&!f.User.isGameOver&&!f.User.isGameDone&&[f.getLastDialogIdx(),f.User.sequence].indexOf(a)>-1},this.scope.goToNextSequence=function(){var a;return a=f.User.nextSequence(),null!=a&&(f.User.isGameOver=a.isGameOver()),a&&a.isSkipped()?f.scope.goToNextSequence():void 0},this.scope.selectOption=function(a,b){var c,d;return f.User.updateCareer({choice:b,scene:f.User.pos()}),null!=a.outro?(c=f.Plot.scene(f.User.chapter,f.User.scene),d={type:"feedback",body:a.outro,next_scene:a.next_scene},c.sequence.push(f.Plot.wrapSequence(d)),f.scope.goToNextSequence()):void 0},this.scope.getSceneBgs=function(){var a,b,c,d,e;if(null!=f.bgs)return f.bgs;if(null==f.scene||!f.scene.decor)return[];for(f.bgs=[{src:f.scene.decor[0].background,sequence:-1}],e=f.scene.sequence,a=c=0,d=e.length;d>c;a=++c)b=e[a],b.isNewBg()&&f.bgs.push({src:b.body,sequence:a});return f.bgs},this.scope.shouldDisplayBg=function(a){var b,c,d,e,g;for(g=_.map(f.bgs,function(a){return a.sequence}),d=0,e=g.length;e>d;d++)c=g[d],c<=f.User.sequence&&(b=c);return 0===a.sequence||a.sequence===b&&f.User.scene===f.scene.id},this.scope.toggleVoicetrack=this.Sound.toggleSequence,this.getLastDialogIdx=this.scope.getLastDialogIdx=function(){var a,b,c,d;for(a=f.User.chapter,b=f.User.scene,d=f.User.sequence;;){if(c=f.Plot.sequence(a,b,d),0>=d||null==c||c.hasExit())break;d--}return d}}return a.$inject=["$scope","Plot","User","Sound","Timeout","constant.characters","constant.settings"],a}(),angular.module("spin.controller").controller("SceneCtrl",SceneCtrl),WelcomeCtrl=function(){function a(a,b){var c=this;this.scope=a,this.User=b,this.scope.user=this.User,this.scope.email=this.User.email,this.scope.submit=function(){return c.User.email=c.scope.email,c.User.inGame=!0}}return a.$inject=["$scope","User"],a}(),angular.module("spin.controller").controller("WelcomeCtrl",WelcomeCtrl),angular.module("spin.directive").directive("chapter",function(){return{restrict:"E",replace:!1,templateUrl:"partials/chapter.html",controller:"ChapterCtrl",scope:{src:"="}}}),angular.module("spin.directive").directive("circle",[function(){return{restrict:"A",replace:!1,scope:{percentage:"="},link:function(a,b,c){var d,e;return e=c.id||"dk-circles-id-"+a.$id,b.attr("id",e),d=function(){var b;return b={id:e,percentage:parseFloat(a.percentage).toFixed(2),radius:parseInt(c.radius,10)||50,width:parseInt(c.width,10)||10,colors:c.colors?c.colors.split(","):["#D3B6C6","#4B253A"],duration:parseInt(c.duration,10)||null,number:" "},null!=c.text&&(b.text=c.text),window.Circles.create(b)},a.percentage?d():a.$watch(function(){return a.percentage},function(){return d()})}}}]),angular.module("spin.directive").directive("preload",function(){return{restrict:"E",scope:{images:"&"},link:function(a){var b,c;return b=function(){return 0===c?a.$broadcast("imagesPreloaded"):void 0},c=0,angular.forEach(a.images(),function(a){var d;return d=new Image,c++,d.onload=function(){return c--,b()},d.src=a}),b()}}}),angular.module("spin.directive").directive("scene",function(){return{restrict:"E",replace:!1,templateUrl:"partials/scene.html",controller:"SceneCtrl",scope:{src:"=",chapter:"="}}}),angular.module("spin.directive").directive("screenHeight",["$window",function(a){return function(b,c,d){var e,f;return e="screenHeight resize",f=function(){return c.css("height",a.innerHeight),isNaN(d.screenHeight)?void 0:c.css("min-height",1*d.screenHeight)},f(),angular.element(a).bind(e,f),b.$on("$destroy",function(){return angular.element(a).unbind(e)})}}]),angular.module("spin.filter").filter("checkmark",function(){return function(a){return a?"✓":"✘"}}),angular.module("spin.filter").filter("media",["constant.settings",function(a){return function(b){return a.mediaUrl+b}}]),angular.module("spin.filter").filter("minutes",function(){return function(a){var b,c;return isNaN(a)&&(a=0),b=Math.floor(a/60),c=Math.round(a-60*b),b=("0"+b).slice(-2),c=("0"+c).slice(-2),""+b+":"+c}}),angular.module("spin.filter").filter("range",function(){return function(a,b){var c;for(b=parseInt(b),c=0;b>c;)a.push(c++);return a}}),angular.module("spin.service").factory("Plot",["$http","constant.api","constant.settings","constant.characters","constant.types",function(a,b,c,d,e){var f;return new(f=function(){function f(){this.sequence=__bind(this.sequence,this),this.scene=__bind(this.scene,this),this.chapter=__bind(this.chapter,this),this.wrapChapters=__bind(this.wrapChapters,this),this.wrapSequence=__bind(this.wrapSequence,this);var c=this;return this.chapters=[],a.get(b.plot).success(function(a){return c.chapters=c.wrapChapters(a)}),this}return f.prototype.sequenceWrappingObject={_wrapped:!0,lowerType:function(){return this.type.toLowerCase()},isDialog:function(){return c.sequenceDialog.indexOf(this.lowerType())>-1},isSkipped:function(){return c.sequenceSkip.indexOf(this.lowerType())>-1},isChoice:function(){return this.lowerType()===e.sequence.choice},isPlayer:function(){return this.lowerType()===e.sequence.player},isNewBg:function(){return this.lowerType()===e.sequence.newBackground},isGameOver:function(){return this.lowerType()===e.sequence.gameOver},isNotification:function(){return this.lowerType()===e.sequence.notification},isFeedback:function(){return this.lowerType()===e.sequence.feedback},hasNext:function(){return c.sequenceWithNext.indexOf(this.lowerType())>-1},hasExit:function(){return this.isPlayer()||this.isDialog()||this.isChoice()||this.isFeedback()},getHeadSrc:function(){var a;return null!=this.character?(a=this.character.toLowerCase().replace(/[^\w-]+/g,""),d[a]):void 0}},f.prototype.wrapSequence=function(a){return a=a||{type:""},a._wrapped||(a=_.extend(a,this.sequenceWrappingObject)),a},f.prototype.wrapChapters=function(a){var b,c,d,e,f,g,h;for(d=0,f=a.length;f>d;d++)for(b=a[d],h=b.scenes,e=0,g=h.length;g>e;e++)c=h[e],c.sequence=_.map(c.sequence,this.wrapSequence);return a},f.prototype.chapter=function(a){return _.find(this.chapters||[],function(b){return b.id===a})},f.prototype.scene=function(a,b){var c;return c=this.chapter(a)||{},_.find(c.scenes||[],function(a){return a.id===b})},f.prototype.sequence=function(a,b,c){var d;return d=this.scene(a,b)||{sequence:[]},d.sequence[c]},f}())}]),angular.module("spin.service").factory("Progression",["$rootScope","Plot","User","Sound","Timeout",function(a,b,c,d,e){var f;return new(f=function(){function f(){a.$watch(function(){return[c.chapter,c.inGame]},c.saveChapterChanging,!0),a.$watch(function(){return c},c.updateLocalStorage,!0),a.$watch(function(){return[b.chapters,c.scene]},function(){return d.startScene()},!0),a.$watch(function(){return c.sequence},function(){return d.toggleSequence(),e.toggleSequence()}),a.$watch(function(){return c.volume},d.updateVolume)}return f}())}]),angular.module("spin.service").factory("Results",["User","Plot","constant.api","$rootScope","$http",function(a,b,c,d,e){var f;return new(f=function(){function f(){this.onChaptersLoaded=__bind(this.onChaptersLoaded,this),this.wrapResult=__bind(this.wrapResult,this),this.wrapResults=__bind(this.wrapResults,this),this.unsentenceIt=__bind(this.unsentenceIt,this),this.resultsForChapter=__bind(this.resultsForChapter,this),this.get=__bind(this.get,this),this.chapters=__bind(this.chapters,this);var a=this;this.list=this.list||{},d.$watch(function(){return a.chapters().length},this.onChaptersLoaded)}return f.prototype.STARTS_WITH_CAPITAL=/^[A-Z]/,f.prototype.chapters=function(){return null!=b.chapters?b.chapters:[]},f.prototype.get=function(a){return this.list[a]},f.prototype.resultsForChapter=function(b){var d,f,g,h=this;return this.list[b.id]?this.list[b.id]:(g=c.results,d={params:{chapter:b.id,token:a.token}},f=e.get(g,d),f.success(function(a){return h.list[b.id]=h.wrapResults(a,b)}),f.error(function(a){var b;return b=["An error occured while getting results of chapter"," "+chapter_id+":"],console.warn(b.join(""),a)}))},f.prototype.unsentenceIt=function(a){return this.STARTS_WITH_CAPITAL.test(a)&&(a=a.replace(a[0],a[0].toLowerCase())),a},f.prototype.wrapResults=function(a,b){var c,d,e;e={chatper:b,list:{}};for(c in a)d=a[c],e.list[c]=this.wrapResult(d);return e},f.prototype.wrapResult=function(a){var b,c,d,e,f;return null!=a.you&&(f=a.you),b=a.options[f],null!=b&&(c=b.percentage,e=this.unsentenceIt(b.title),d={userChoice:b,percentage:{sentence:"Comme <b>"+c+"%</b> des utilisateurs, "+e,raw:c,style:{width:""+c+"%"}}},a=_.extend(a,d)),a},f.prototype.onChaptersLoaded=function(c){var d,e,f,g,h;if(c&&c>0){for(f=b.chapter(a.chapter),g=b.chapters.indexOf(f),e=0,h=[];g+1>e;)d=b.chapters[e],this.resultsForChapter(d),h.push(e++);return h}},f}())}]),angular.module("spin.service").factory("Sound",["User","Plot","$rootScope","$filter",function(a,b,c,d){var e;return new(e=function(){function e(){this.updateVolume=__bind(this.updateVolume,this),this.toggleSequence=__bind(this.toggleSequence,this),this.startScene=__bind(this.startScene,this),this.startSoundTrack=__bind(this.startSoundTrack,this)}return e.prototype.startSoundTrack=function(b){var d=this;return this.soundtrack=new Howl({urls:b,loop:!0,buffer:!0,volume:0,onplay:function(){return c.safeApply(function(){return d.soundtrack.isPlaying=!0})},onpause:function(){return c.safeApply(function(){return d.soundtrack.isPlaying=!1})},onend:function(){return c.safeApply(function(){return d.soundtrack.isPlaying=!1})}}),this.soundtrack.play(function(){return d.soundtrack.fade(0,a.volume,1e3)})},e.prototype.startScene=function(c,e){var f,g=this;if(null==c&&(c=a.chapter),null==e&&(e=a.scene),null!=e&&b.chapters.length&&null!=b.scene(c,e)&&(e=b.scene(c,e),f=[d("media")(e.decor[0].soundtrack)],null!=e.decor[0].soundtrack)){if(null==this.soundtrack)return this.startSoundTrack(f);if(!angular.equals(this.soundtrack.urls(),f))return this.soundtrack.fade(a.volume,0,1e3,function(){return g.startSoundTrack(f)})}},e.prototype.toggleSequence=function(e,f,g){var h,i,j=this;if(null==e&&(e=a.chapter),null==f&&(f=a.scene),null==g&&(g=a.sequence),null!=g)if(h=b.sequence(e,f,g),null!=h&&"voixoff"===h.type){if(i=[d("media")(h.body)],null==this.voicetrack||!angular.equals(this.voicetrack.urls(),i))return this.voicetrack=new Howl({urls:i,loop:!1,buffer:!0,volume:0,autoplay:!0,onplay:function(){return c.safeApply(function(){var b;return null!=j.soundtrack&&j.soundtrack.fade(j.soundtrack.volume(),a.volume/2),b=0===j.soundtrack.pos()?1e3:0,j.voicetrack.fade(0,a.volume,b),j.voicetrack.isPlaying=!0,j.voicetrack._interval=setInterval(function(a){return a.voicetrack._position=a.voicetrack.pos()||0,function(){return null!=a.voicetrack&&a.voicetrack.isPlaying?c.safeApply(function(){return a.voicetrack._position=a.voicetrack.pos()}):void 0}}(j),500)})},onpause:function(){return c.safeApply(function(){return j.voicetrack.isPlaying=!1})},onend:function(){return c.safeApply(function(){return null!=j.soundtrack&&j.soundtrack.fade(j.soundtrack.volume(),a.volume),c.safeApply(function(){return j.voicetrack._position=j.voicetrack._duration}),j.voicetrack.pos(0),j.voicetrack.isPlaying=!1,clearInterval(j.voicetrack._interval)})}});if(null!=this.voicetrack&&!this.voicetrack.isPlaying)return this.voicetrack.play();if(null!=this.voicetrack&&null!=this.voicetrack.isPlaying)return this.voicetrack.pause()}else if(null!=this.voicetrack&&(this.voicetrack.stop(),this.voicetrack=null),null!=h&&"notification"===h.type)return i=[d("media")(h.sound)],this.notificationtrack=new Howl({urls:i,loop:!1,buffer:!0,volume:a.volume,autoplay:!0,onplay:function(){return c.safeApply(function(){return j.notificationtrack.isPlaying=!0})},onpause:function(){return c.safeApply(function(){return j.notificationtrack.isPlaying=!1})},onend:function(){return c.safeApply(function(){return j.notificationtrack.isPlaying=!1})}})},e.prototype.updateVolume=function(a){if(null!=a)switch(!0){case null!=this.voicetrack&&null!=this.soundtrack:return this.voicetrack.volume(a),this.soundtrack.volume(a/2);case null!=this.voicetrack:return this.voicetrack.volume(a);case null!=this.soundtrack:return this.soundtrack.volume(a)}},e}())}]),angular.module("spin.service").service("ThirdParty",["$http","$window",function(a,b){var c;return new(c=function(){function a(){this.shareOnGplus=__bind(this.shareOnGplus,this),this.shareOnTwitter=__bind(this.shareOnTwitter,this),this.shareOnFacebook=__bind(this.shareOnFacebook,this),this.url="http://jeu-d-influences.france5.fr/"}return a.prototype.shareOnFacebook=function(a){var c;return null==a&&(a=this.url),c="https://www.facebook.com/sharer/sharer.php?u="+a+"&display=popup",b.open(c,"shareOnFacebook","menubar=no, status=no, scrollbars=no, menubar=no, width=670, height=370"),!0},a.prototype.shareOnTwitter=function(a){var c,d;return null==a&&(a=this.url),d="WOW, such game {URL}",d=d.replace("{URL}",this.url),d=encodeURIComponent(d),c="https://twitter.com/share?&text="+d+"&url=&",b.open(c,"shareOnTwitter","menubar=no, status=no, scrollbars=no, menubar=no, width=550, height=380"),!0},a.prototype.shareOnGplus=function(a){var c;return null==a&&(a=this.url),c="https://plus.google.com/share?url="+a,b.open(c,"shareOnGplus","menubar=no, status=no, scrollbars=no, menubar=no, width=600, height=600"),!0},a}())}]),angular.module("spin.service").factory("Timeout",["$rootScope","User","Plot","constant.settings","$timeout",function(a,b,c,d,e){var f;return new(f=function(){function a(){this.timeStep=__bind(this.timeStep,this),this.toggleSequence=__bind(this.toggleSequence,this),this.remainingTime=0,this._lastStep=null,this._timeout=void 0}return a.prototype.toggleSequence=function(a,f,g){if(null==a&&(a=b.chapter),null==f&&(f=b.scene),null==g&&(g=b.sequence),null!=g){if(null!=this._timeout&&(e.cancel(this._timeout),this._timeout=void 0),this.sequence=c.sequence(a,f,g),null==this.sequence)return;if("choice"===this.sequence.type&&null!=this.sequence.delay)return this.remainingTime=0,this._step=100*d.timeoutRefRate/(1e3*this.sequence.delay),this._timeout=e(this.timeStep,d.timeoutRefRate),this._lastStep=Date.now();if("feedback"===this.sequence.type)return e(function(a){return function(){return b.goToScene(a.next_scene)}}(this.sequence),d.feedbackDuration)}},a.prototype.timeStep=function(){var a,c,f;if(null!=this._timeout&&(a=Date.now(),this.remainingTime+=(a-this._lastStep)*(100/(1e3*this.sequence.delay)),!isNaN(this.remainingTime)))return this.remainingTime<100?(e(this.timeStep,d.timeoutRefRate),this._lastStep=a):(this._timeout=void 0,f=0,null!=this.sequence.default_option&&(f=this.sequence.default_option),c=this.sequence.options[f],this.remainingTime=0,this._lastStep=null,b.updateCareer({choice:f,scene:b.pos()}),b.goToScene(c.next_scene))},a}())}]),angular.module("spin.service").factory("User",["$http","$timeout","constant.api","constant.settings","UserIndicators","Plot","localStorageService","$location","$rootScope",function(a,b,c,d,e,f,g,h,i){var j;return new(j=function(){function j(){this.goToScene=__bind(this.goToScene,this),this.associate=__bind(this.associate,this),this.isSequenceConditionOk=__bind(this.isSequenceConditionOk,this),this.nextSequence=__bind(this.nextSequence,this),this.updateCareer=__bind(this.updateCareer,this),this.createNewCareer=__bind(this.createNewCareer,this),this.loadCareer=__bind(this.loadCareer,this),this.chapterTrackingLoop=__bind(this.chapterTrackingLoop,this),this.saveChapterChanging=__bind(this.saveChapterChanging,this),this.isStartingChapter=__bind(this.isStartingChapter,this),this.checkProgression=__bind(this.checkProgression,this),this.updateProgression=__bind(this.updateProgression,this),this.updateLocalStorage=__bind(this.updateLocalStorage,this),this.newUser=__bind(this.newUser,this),this.chapterProgression=__bind(this.chapterProgression,this),this.pos=__bind(this.pos,this);var a,b=this;return a=g.get("user")||{},this.inGame=!1,this.isGameOver=!1,this.isGameDone=!1,this.token=h.search().token||a.token||null,this.email=a.email||null,this.scenes=a.scenes||[],this.volume=isNaN(a.volume)?.5:a.volume,this.chapter=a.chapter||"1",this.scene=a.scene||"1",this.sequence=a.sequence||0,this.indicators={stress:e.stress.meta.start,trust:e.trust.meta.start,ubm:e.ubm.meta.start,culpabilite:0,honnetete:100,karma:0},i.$watch(function(){return b.inGame},function(a,c){return a&&!c?b.loadCareer():void 0},!0),this}return j.prototype.pos=function(){return this.chapter+"."+this.scene},j.prototype.chapterProgression=function(){var a;return a=_.intersection(d.mainScenes[this.chapter],this.scenes),Math.round(Math.min(a.length,3)/3*100)},j.prototype.newUser=function(){var a,b;return a=[null,null],this.token=a[0],this.email=a[1],b=["1","1",0],this.chapter=b[0],this.scene=b[1],this.sequence=b[2],this.loadCareer()},j.prototype.updateLocalStorage=function(a){return null==a&&(a=this),null!=a?g.set("user",a):void 0},j.prototype.updateProgression=function(a){var b,c,d,e;if(null!=a.reached_scene&&"string"==typeof a.reached_scene){d=a.reached_scene.split("."),this.chapter=d[0],this.scene=d[1],this.scenes=a.scenes,e=a.context;for(b in e)__hasProp.call(e,b)&&(c=e[b],this.indicators[b]=c);this.sequence=0,this.isSequenceConditionOk()||this.nextSequence()}return this.checkProgression()},j.prototype.checkProgression=function(){var a,b,c,d,f,g;for(c=!1,a=!1;c===!1&&a===!1;){g=this.indicators;for(d in g)f=g[d],b=e[d],b&&(c=b.isGameOver(f));a=!0}return this.isGameOver=c,c},j.prototype.isStartingChapter=function(){return Date.now()-this.lastChapterChanging<d.chapterEntrance},j.prototype.saveChapterChanging=function(a){return null!=a?(this.lastChapterChanging=Date.now(),null!=this.trackChapterChanging&&b.cancel(this.trackChapterChanging),this.chapterTrackingLoop()):void 0},j.prototype.chapterTrackingLoop=function(){return this.isStartingChapter()||null==this.trackChapterChanging?this.trackChapterChanging=b(this.chapterTrackingLoop,200):b.cancel(this.trackChapterChanging)},j.prototype.loadCareer=function(){var b=this;return null!=this.token?a.get(""+c.career+"?token="+this.token).success(this.updateProgression).error(function(){return null!=b.token||null!=b.email?b.newUser():void 0}):this.createNewCareer(null!=this.email)},j.prototype.createNewCareer=function(b){var d=this;return null==b&&(b=!1),a.post(""+c.career,{reached_scene:"1.1"}).success(function(a){return d.token=a.token,b&&d.associate(d.email),d.loadCareer()})},j.prototype.updateCareer=function(b){var d,e,g,h,i,j;return this.token?(null!=b?(i=b,j=b.scene.split("."),d=j[0],g=j[1],h=f.sequence(d,g,this.sequence),null!=h.options&&(e=h.options[b.choice])):i={reached_scene:this.pos()},a.post(""+c.career+"?token="+this.token,i).success(this.updateProgression)):!1},j.prototype.nextSequence=function(){var a,b,c,d,e;if(b=f.scene(this.chapter,this.scene),c=f.sequence(this.chapter,this.scene,this.sequence),c.result){e=c.result;for(a in e)d=e[a],this.indicators[a]+=d}return null!=f.sequence(this.chapter,this.scene,this.sequence+1)?(++this.sequence,c=f.sequence(this.chapter,this.scene,this.sequence),this.isSequenceConditionOk(c)||(c=this.nextSequence()),c):b&&null!=b.next_scene?(this.goToScene(b.next_scene),f.sequence(this.chapter,this.scene,this.sequence)):void 0},j.prototype.isSequenceConditionOk=function(a){var b,c,e;if(a=a||f.sequence(this.chapter,this.scene,this.sequence),a.condition){e=a.condition;for(b in e)if(c=e[b],this.indicators[b]!==c)return!1}return d.sequenceSkip.indexOf(a.type)>=0?!1:!0},j.prototype.associate=function(b){return null!=b&&""!==b?a({url:""+c.associate+"?token="+this.token,method:"POST",data:{email:b}}):void 0},j.prototype.goToScene=function(a,b){var c,d,e,g,h,i,j;return null==b&&(b=!0),"string"==typeof a?e=a:(d=this.indicators.karma>=0?"positif":"negatif",e=a[""+d+"_karma"]),i=e.split("."),c=i[0],g=i[1],h=function(a){return console.warn(""+a+" doesn't exist ("+e+").")},null==f.chapter(c)?h("Chapter"):null==f.scene(c,g)?h("Scene"):this.chapter===c&&this.scene===g?null==f.sequence(c,g,this.sequence+1)?h("Next sequence"):this.nextSequence():(j=[c,g,0],this.chapter=j[0],this.scene=j[1],this.sequence=j[2],this.isSequenceConditionOk()||this.nextSequence(),b?this.updateCareer():void 0)},j}())}]),assert=function(a){if(!a)throw"Assertion failed"},angular.module("spin.service").factory("UserIndicators",["constant.indicators",function(a){var b;return new(b=function(){function b(){this.bindIndicators=__bind(this.bindIndicators,this),this.bindRules=__bind(this.bindRules,this),this.bindRules(a.meta.rules),this.bindIndicators(a.all)}return b.prototype.bindRules=function(a){return this.genericFunctions=this.genericFunctions||{},this.genericFunctions[a.lessThanOrEqual]=function(a,b){return b>=a},this.genericFunctions[a.lessThan]=function(a,b){return b>a},this.genericFunctions[a.greaterThanOrEqual]=function(a,b){return a>=b},this.genericFunctions[a.greaterThan]=function(a,b){return a>b}},b.prototype.bindIndicators=function(a){var b,c,d,e,f,g;g=[];for(f in a)e=a[f],b=e.gameOver.rule,c=e[e.gameOver.on],d=this.genericFunctions[b],g.push(this[f]={meta:e,gameOverFunction:d,gameOverValue:c,isGameOver:function(a){return this.gameOverFunction(a,this.gameOverValue)}});return g},b}())}]);